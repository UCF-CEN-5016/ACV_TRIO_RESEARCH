<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MariaDBSchema.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.mariadb</a> &gt; <span class="el_source">MariaDBSchema.java</span></div><h1>MariaDBSchema.java</h1><pre class="source lang-java linenums">package dqetool.mariadb;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.SQLIntegrityConstraintViolationException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;
import java.util.function.Function;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import dqetool.Randomly;
import dqetool.SQLConnection;
import dqetool.common.schema.AbstractRelationalTable;
import dqetool.common.schema.AbstractSchema;
import dqetool.common.schema.AbstractTableColumn;
import dqetool.common.schema.TableIndex;
import dqetool.mariadb.MariaDBProvider.MariaDBGlobalState;
import dqetool.mariadb.MariaDBSchema.MariaDBTable;
import dqetool.mariadb.MariaDBSchema.MariaDBTable.MariaDBEngine;

public class MariaDBSchema extends AbstractSchema&lt;MariaDBGlobalState, MariaDBTable&gt; {

    private static final int NR_SCHEMA_READ_TRIES = 10;

<span class="nc" id="L27">    public enum MariaDBDataType {</span>
<span class="nc" id="L28">        INT, VARCHAR, REAL, BOOLEAN;</span>
    }

    public static class MariaDBColumn extends AbstractTableColumn&lt;MariaDBTable, MariaDBDataType&gt; {

        private final boolean isPrimaryKey;
        private final int precision;

<span class="nc" id="L36">        public enum CollateSequence {</span>
<span class="nc" id="L37">            NOCASE, RTRIM, BINARY;</span>

            public static CollateSequence random() {
<span class="nc" id="L40">                return Randomly.fromOptions(values());</span>
            }
        }

        public MariaDBColumn(String name, MariaDBDataType columnType, boolean isPrimaryKey, int precision) {
<span class="nc" id="L45">            super(name, null, columnType);</span>
<span class="nc" id="L46">            this.isPrimaryKey = isPrimaryKey;</span>
<span class="nc" id="L47">            this.precision = precision;</span>
<span class="nc" id="L48">        }</span>

        public int getPrecision() {
<span class="nc" id="L51">            return precision;</span>
        }

        public boolean isPrimaryKey() {
<span class="nc" id="L55">            return isPrimaryKey;</span>
        }

    }

    public static class MariaDBTables {
        private final List&lt;MariaDBTable&gt; tables;
        private final List&lt;MariaDBColumn&gt; columns;

<span class="nc" id="L64">        public MariaDBTables(List&lt;MariaDBTable&gt; tables) {</span>
<span class="nc" id="L65">            this.tables = tables;</span>
<span class="nc" id="L66">            columns = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">            for (MariaDBTable t : tables) {</span>
<span class="nc" id="L68">                columns.addAll(t.getColumns());</span>
            }
<span class="nc" id="L70">        }</span>

        public String tableNamesAsString() {
<span class="nc" id="L73">            return tables.stream().map(t -&gt; t.getName()).collect(Collectors.joining(&quot;, &quot;));</span>
        }

        public List&lt;MariaDBTable&gt; getTables() {
<span class="nc" id="L77">            return tables;</span>
        }

        public List&lt;MariaDBColumn&gt; getColumns() {
<span class="nc" id="L81">            return columns;</span>
        }

        public String columnNamesAsString() {
<span class="nc" id="L85">            return getColumns().stream().map(t -&gt; t.getTable().getName() + &quot;.&quot; + t.getName())</span>
<span class="nc" id="L86">                    .collect(Collectors.joining(&quot;, &quot;));</span>
        }

        public String columnNamesAsString(Function&lt;MariaDBColumn, String&gt; function) {
<span class="nc" id="L90">            return getColumns().stream().map(function).collect(Collectors.joining(&quot;, &quot;));</span>
        }
    }

    private static MariaDBDataType getColumnType(String typeString) {
<span class="nc bnc" id="L95" title="All 4 branches missed.">        switch (typeString) {</span>
        case &quot;tinyint&quot;:
        case &quot;smallint&quot;:
        case &quot;mediumint&quot;:
        case &quot;int&quot;:
        case &quot;bigint&quot;:
<span class="nc" id="L101">            return MariaDBDataType.INT;</span>
        case &quot;varchar&quot;:
        case &quot;tinytext&quot;:
        case &quot;mediumtext&quot;:
        case &quot;text&quot;:
        case &quot;longtext&quot;:
        case &quot;char&quot;:
<span class="nc" id="L108">            return MariaDBDataType.VARCHAR;</span>
        case &quot;real&quot;:
        case &quot;double&quot;:
<span class="nc" id="L111">            return MariaDBDataType.REAL;</span>
        default:
<span class="nc" id="L113">            throw new AssertionError(typeString);</span>
        }
    }

    public static class MariaDBTable extends AbstractRelationalTable&lt;MariaDBColumn, MariaDBIndex, MariaDBGlobalState&gt; {

<span class="nc" id="L119">        public enum MariaDBEngine {</span>

<span class="nc" id="L121">            INNO_DB(&quot;InnoDB&quot;), MY_ISAM(&quot;MyISAM&quot;), ARIA(&quot;Aria&quot;);</span>

            private String s;

<span class="nc" id="L125">            MariaDBEngine(String s) {</span>
<span class="nc" id="L126">                this.s = s;</span>
<span class="nc" id="L127">            }</span>

            public String getTextRepresentation() {
<span class="nc" id="L130">                return s;</span>
            }

            public static MariaDBEngine get(String val) {
<span class="nc" id="L134">                return Stream.of(values()).filter(engine -&gt; engine.s.equalsIgnoreCase(val)).findFirst().get();</span>
            }

            public static MariaDBEngine getRandomEngine() {
<span class="nc" id="L138">                return Randomly.fromOptions(MariaDBEngine.values());</span>
            }

        }

        private final MariaDBEngine engine;

        public MariaDBTable(String tableName, List&lt;MariaDBColumn&gt; columns, List&lt;MariaDBIndex&gt; indexes,
                MariaDBEngine engine) {
<span class="nc" id="L147">            super(tableName, columns, indexes, false);</span>
<span class="nc" id="L148">            this.engine = engine;</span>
<span class="nc" id="L149">        }</span>

        public MariaDBEngine getEngine() {
<span class="nc" id="L152">            return engine;</span>
        }

    }

    public static final class MariaDBIndex extends TableIndex {

        private MariaDBIndex(String indexName) {
<span class="nc" id="L160">            super(indexName);</span>
<span class="nc" id="L161">        }</span>

        @Override
        public String getIndexName() {
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (super.getIndexName().contentEquals(&quot;PRIMARY&quot;)) {</span>
<span class="nc" id="L166">                return &quot;`PRIMARY`&quot;;</span>
            } else {
<span class="nc" id="L168">                return super.getIndexName();</span>
            }
        }

    }

    public static MariaDBSchema fromConnection(SQLConnection con, String databaseName) throws SQLException {
<span class="nc" id="L175">        Exception ex = null;</span>
        /* the loop is a workaround for https://bugs.MariaDB.com/bug.php?id=95929 */
<span class="nc bnc" id="L177" title="All 2 branches missed.">        for (int i = 0; i &lt; NR_SCHEMA_READ_TRIES; i++) {</span>
            try {
<span class="nc" id="L179">                List&lt;MariaDBTable&gt; databaseTables = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L180">                try (Statement s = con.createStatement()) {</span>
<span class="nc" id="L181">                    try (ResultSet rs = s.executeQuery(</span>
<span class="nc" id="L182">                            &quot;select TABLE_NAME, ENGINE from information_schema.TABLES where table_schema = '&quot;</span>
<span class="nc" id="L183">                                    + databaseName + &quot;';&quot;)) {</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                        while (rs.next()) {</span>
<span class="nc" id="L185">                            String tableName = rs.getString(&quot;TABLE_NAME&quot;);</span>
<span class="nc" id="L186">                            String tableEngineStr = rs.getString(&quot;ENGINE&quot;);</span>
<span class="nc" id="L187">                            MariaDBEngine engine = MariaDBEngine.get(tableEngineStr);</span>
<span class="nc" id="L188">                            List&lt;MariaDBColumn&gt; databaseColumns = getTableColumns(con, tableName, databaseName);</span>
<span class="nc" id="L189">                            List&lt;MariaDBIndex&gt; indexes = getIndexes(con, tableName, databaseName);</span>
<span class="nc" id="L190">                            MariaDBTable t = new MariaDBTable(tableName, databaseColumns, indexes, engine);</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">                            for (MariaDBColumn c : databaseColumns) {</span>
<span class="nc" id="L192">                                c.setTable(t);</span>
                            }
<span class="nc" id="L194">                            databaseTables.add(t);</span>
                        }
                    }
                }
<span class="nc" id="L198">                return new MariaDBSchema(databaseTables);</span>
<span class="nc" id="L199">            } catch (SQLIntegrityConstraintViolationException e) {</span>
<span class="nc" id="L200">                ex = e;</span>
            }
        }
<span class="nc" id="L203">        throw new AssertionError(ex);</span>
    }

    private static List&lt;MariaDBIndex&gt; getIndexes(SQLConnection con, String tableName, String databaseName)
            throws SQLException {
<span class="nc" id="L208">        List&lt;MariaDBIndex&gt; indexes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L209">        try (Statement s = con.createStatement()) {</span>
<span class="nc" id="L210">            try (ResultSet rs = s.executeQuery(String.format(</span>
<span class="nc" id="L211">                    &quot;SELECT INDEX_NAME FROM INFORMATION_SCHEMA.STATISTICS WHERE TABLE_SCHEMA = '%s' AND TABLE_NAME='%s';&quot;,</span>
<span class="nc" id="L212">                    databaseName, tableName))) {</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L214">                    String indexName = rs.getString(&quot;INDEX_NAME&quot;);</span>
<span class="nc" id="L215">                    indexes.add(new MariaDBIndex(indexName));</span>
                }
            }
        }
<span class="nc" id="L219">        return indexes;</span>
    }

    private static List&lt;MariaDBColumn&gt; getTableColumns(SQLConnection con, String tableName, String databaseName)
            throws SQLException {
<span class="nc" id="L224">        List&lt;MariaDBColumn&gt; columns = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L225">        try (Statement s = con.createStatement()) {</span>
<span class="nc" id="L226">            try (ResultSet rs = s.executeQuery(&quot;select * from information_schema.columns where table_schema = '&quot;</span>
<span class="nc" id="L227">                    + databaseName + &quot;' AND TABLE_NAME='&quot; + tableName + &quot;'&quot;)) {</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L229">                    String columnName = rs.getString(&quot;COLUMN_NAME&quot;);</span>
<span class="nc" id="L230">                    String dataType = rs.getString(&quot;DATA_TYPE&quot;);</span>
<span class="nc" id="L231">                    int precision = rs.getInt(&quot;NUMERIC_PRECISION&quot;);</span>
<span class="nc" id="L232">                    boolean isPrimaryKey = rs.getString(&quot;COLUMN_KEY&quot;).equals(&quot;PRI&quot;);</span>
<span class="nc" id="L233">                    MariaDBColumn c = new MariaDBColumn(columnName, getColumnType(dataType), isPrimaryKey, precision);</span>
<span class="nc" id="L234">                    columns.add(c);</span>
                }
            }
        }
<span class="nc" id="L238">        return columns;</span>
    }

    public MariaDBSchema(List&lt;MariaDBTable&gt; databaseTables) {
<span class="nc" id="L242">        super(databaseTables);</span>
<span class="nc" id="L243">    }</span>

    public MariaDBTables getRandomTableNonEmptyTables(){
<span class="nc" id="L246">        return new MariaDBTables(Randomly.nonEmptySubset(getDatabaseTables()));</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>