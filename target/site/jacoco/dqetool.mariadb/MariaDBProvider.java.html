<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MariaDBProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.mariadb</a> &gt; <span class="el_source">MariaDBProvider.java</span></div><h1>MariaDBProvider.java</h1><pre class="source lang-java linenums">package dqetool.mariadb;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

import com.google.auto.service.AutoService;

import dqetool.DatabaseProvider;
import dqetool.IgnoreMeException;
import dqetool.MainOptions;
import dqetool.Randomly;
import dqetool.SQLConnection;
import dqetool.SQLGlobalState;
import dqetool.SQLProviderAdapter;
import dqetool.common.DBMSCommon;
import dqetool.common.query.SQLQueryAdapter;
import dqetool.mariadb.MariaDBProvider.MariaDBGlobalState;
import dqetool.mariadb.gen.MariaDBIndexGenerator;
import dqetool.mariadb.gen.MariaDBInsertGenerator;
import dqetool.mariadb.gen.MariaDBSetGenerator;
import dqetool.mariadb.gen.MariaDBTableAdminCommandGenerator;
import dqetool.mariadb.gen.MariaDBTableGenerator;
import dqetool.mariadb.gen.MariaDBTruncateGenerator;
import dqetool.mariadb.gen.MariaDBUpdateGenerator;

@AutoService(DatabaseProvider.class)
public class MariaDBProvider extends SQLProviderAdapter&lt;MariaDBGlobalState, MariaDBOptions&gt; {

<span class="fc" id="L33">    public static final int MAX_EXPRESSION_DEPTH = 3;</span>

    public MariaDBProvider() {
<span class="fc" id="L36">        super(MariaDBGlobalState.class, MariaDBOptions.class);</span>
<span class="fc" id="L37">    }</span>

<span class="nc" id="L39">    enum Action {</span>
<span class="nc" id="L40">        ANALYZE_TABLE, //</span>
<span class="nc" id="L41">        CHECKSUM, //</span>
<span class="nc" id="L42">        CHECK_TABLE, //</span>
<span class="nc" id="L43">        CREATE_INDEX, //</span>
<span class="nc" id="L44">        INSERT, //</span>
<span class="nc" id="L45">        OPTIMIZE, //</span>
<span class="nc" id="L46">        REPAIR_TABLE, //</span>
<span class="nc" id="L47">        SET, //</span>
<span class="nc" id="L48">        TRUNCATE, //</span>
<span class="nc" id="L49">        UPDATE, //</span>
    }

    @Override
    public void generateDatabase(MariaDBGlobalState globalState) throws Exception {
<span class="nc" id="L54">        MainOptions options = globalState.getOptions();</span>

<span class="nc bnc" id="L56" title="All 2 branches missed.">        while (globalState.getSchema().getDatabaseTables().size() &lt; Randomly.smallNumber() + 1) {</span>
<span class="nc" id="L57">            String tableName = DBMSCommon.createTableName(globalState.getSchema().getDatabaseTables().size());</span>
<span class="nc" id="L58">            SQLQueryAdapter createTable = MariaDBTableGenerator.generate(tableName, globalState.getRandomly(),</span>
<span class="nc" id="L59">                    globalState.getSchema());</span>
<span class="nc" id="L60">            globalState.executeStatement(createTable);</span>
        }

<span class="nc" id="L63">        int[] nrRemaining = new int[Action.values().length];</span>
<span class="nc" id="L64">        List&lt;Action&gt; actions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L65">        int total = 0;</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        for (int i = 0; i &lt; Action.values().length; i++) {</span>
<span class="nc" id="L67">            Action action = Action.values()[i];</span>
<span class="nc" id="L68">            int nrPerformed = 0;</span>
<span class="nc bnc" id="L69" title="All 4 branches missed.">            switch (action) {</span>
            case CHECKSUM:
            case CHECK_TABLE:
            case TRUNCATE:
            case REPAIR_TABLE:
            case OPTIMIZE:
            case ANALYZE_TABLE:
            case UPDATE:
            case CREATE_INDEX:
<span class="nc" id="L78">                nrPerformed = globalState.getRandomly().getInteger(0, 2);</span>
<span class="nc" id="L79">                break;</span>
            case SET:
<span class="nc" id="L81">                nrPerformed = 20;</span>
<span class="nc" id="L82">                break;</span>
            case INSERT:
<span class="nc" id="L84">                nrPerformed = globalState.getRandomly().getInteger(0, options.getMaxNumberInserts());</span>
<span class="nc" id="L85">                break;</span>
            default:
<span class="nc" id="L87">                throw new AssertionError(action);</span>
            }
<span class="nc bnc" id="L89" title="All 2 branches missed.">            if (nrPerformed != 0) {</span>
<span class="nc" id="L90">                actions.add(action);</span>
            }
<span class="nc" id="L92">            nrRemaining[action.ordinal()] = nrPerformed;</span>
<span class="nc" id="L93">            total += nrPerformed;</span>
        }
<span class="nc bnc" id="L95" title="All 2 branches missed.">        while (total != 0) {</span>
<span class="nc" id="L96">            Action nextAction = null;</span>
<span class="nc" id="L97">            int selection = globalState.getRandomly().getInteger(0, total);</span>
<span class="nc" id="L98">            int previousRange = 0;</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            for (int i = 0; i &lt; nrRemaining.length; i++) {</span>
<span class="nc bnc" id="L100" title="All 4 branches missed.">                if (previousRange &lt;= selection &amp;&amp; selection &lt; previousRange + nrRemaining[i]) {</span>
<span class="nc" id="L101">                    nextAction = Action.values()[i];</span>
<span class="nc" id="L102">                    break;</span>
                } else {
<span class="nc" id="L104">                    previousRange += nrRemaining[i];</span>
                }
            }
<span class="nc bnc" id="L107" title="All 2 branches missed.">            assert nextAction != null;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            assert nrRemaining[nextAction.ordinal()] &gt; 0;</span>
<span class="nc" id="L109">            nrRemaining[nextAction.ordinal()]--;</span>
            SQLQueryAdapter query;
            try {
<span class="nc bnc" id="L112" title="All 11 branches missed.">                switch (nextAction) {</span>
                case CHECKSUM:
<span class="nc" id="L114">                    query = MariaDBTableAdminCommandGenerator.checksumTable(globalState.getSchema());</span>
<span class="nc" id="L115">                    break;</span>
                case CHECK_TABLE:
<span class="nc" id="L117">                    query = MariaDBTableAdminCommandGenerator.checkTable(globalState.getSchema());</span>
<span class="nc" id="L118">                    break;</span>
                case TRUNCATE:
<span class="nc" id="L120">                    query = MariaDBTruncateGenerator.truncate(globalState.getSchema());</span>
<span class="nc" id="L121">                    break;</span>
                case REPAIR_TABLE:
<span class="nc" id="L123">                    query = MariaDBTableAdminCommandGenerator.repairTable(globalState.getSchema());</span>
<span class="nc" id="L124">                    break;</span>
                case INSERT:
<span class="nc" id="L126">                    query = MariaDBInsertGenerator.insert(globalState.getSchema(), globalState.getRandomly());</span>
<span class="nc" id="L127">                    break;</span>
                case OPTIMIZE:
<span class="nc" id="L129">                    query = MariaDBTableAdminCommandGenerator.optimizeTable(globalState.getSchema());</span>
<span class="nc" id="L130">                    break;</span>
                case ANALYZE_TABLE:
<span class="nc" id="L132">                    query = MariaDBTableAdminCommandGenerator.analyzeTable(globalState.getSchema());</span>
<span class="nc" id="L133">                    break;</span>
                case UPDATE:
<span class="nc" id="L135">                    query = MariaDBUpdateGenerator.update(globalState.getSchema(), globalState.getRandomly());</span>
<span class="nc" id="L136">                    break;</span>
                case CREATE_INDEX:
<span class="nc" id="L138">                    query = MariaDBIndexGenerator.generate(globalState.getSchema());</span>
<span class="nc" id="L139">                    break;</span>
                case SET:
<span class="nc" id="L141">                    query = MariaDBSetGenerator.set(globalState.getRandomly(), options);</span>
<span class="nc" id="L142">                    break;</span>
                default:
<span class="nc" id="L144">                    throw new AssertionError(nextAction);</span>
                }
<span class="nc" id="L146">            } catch (IgnoreMeException e) {</span>
<span class="nc" id="L147">                total--;</span>
<span class="nc" id="L148">                continue;</span>
            }
            try {
<span class="nc" id="L151">                globalState.executeStatement(query);</span>
<span class="nc" id="L152">            } catch (Throwable t) {</span>
<span class="nc" id="L153">                System.err.println(query.getQueryString());</span>
<span class="nc" id="L154">                throw t;</span>
            }
<span class="nc" id="L156">            total--;</span>
        }
<span class="nc" id="L158">    }</span>

<span class="nc" id="L160">    public static class MariaDBGlobalState extends SQLGlobalState&lt;MariaDBOptions, MariaDBSchema&gt; {</span>

        @Override
        protected MariaDBSchema readSchema() throws SQLException {
<span class="nc" id="L164">            return MariaDBSchema.fromConnection(getConnection(), getDatabaseName());</span>
        }

    }

    @Override
    public SQLConnection createDatabase(MariaDBGlobalState globalState) throws SQLException {
<span class="nc" id="L171">        globalState.getState().logStatement(&quot;DROP DATABASE IF EXISTS &quot; + globalState.getDatabaseName());</span>
<span class="nc" id="L172">        globalState.getState().logStatement(&quot;CREATE DATABASE &quot; + globalState.getDatabaseName());</span>
<span class="nc" id="L173">        globalState.getState().logStatement(&quot;USE &quot; + globalState.getDatabaseName());</span>
<span class="nc" id="L174">        String username = globalState.getOptions().getUserName();</span>
<span class="nc" id="L175">        String password = globalState.getOptions().getPassword();</span>
<span class="nc" id="L176">        String host = globalState.getOptions().getHost();</span>
<span class="nc" id="L177">        int port = globalState.getOptions().getPort();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (host == null) {</span>
<span class="nc" id="L179">            host = MariaDBOptions.DEFAULT_HOST;</span>
        }
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (port == MainOptions.NO_SET_PORT) {</span>
<span class="nc" id="L182">            port = MariaDBOptions.DEFAULT_PORT;</span>
        }
<span class="nc" id="L184">        String url = String.format(&quot;jdbc:mariadb://%s:%d&quot;, host, port);</span>
<span class="nc" id="L185">        Connection con = DriverManager.getConnection(url, username, password);</span>
<span class="nc" id="L186">        try (Statement s = con.createStatement()) {</span>
<span class="nc" id="L187">            s.execute(&quot;DROP DATABASE IF EXISTS &quot; + globalState.getDatabaseName());</span>
        }
<span class="nc" id="L189">        try (Statement s = con.createStatement()) {</span>
<span class="nc" id="L190">            s.execute(&quot;CREATE DATABASE &quot; + globalState.getDatabaseName());</span>
        }
<span class="nc" id="L192">        try (Statement s = con.createStatement()) {</span>
<span class="nc" id="L193">            s.execute(&quot;USE &quot; + globalState.getDatabaseName());</span>
        }
<span class="nc" id="L195">        return new SQLConnection(con);</span>
    }

    @Override
    public String getDBMSName() {
<span class="fc" id="L200">        return &quot;mariadb&quot;;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>