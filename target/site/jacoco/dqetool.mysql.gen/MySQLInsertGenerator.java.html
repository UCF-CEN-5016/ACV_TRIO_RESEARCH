<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MySQLInsertGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.mysql.gen</a> &gt; <span class="el_source">MySQLInsertGenerator.java</span></div><h1>MySQLInsertGenerator.java</h1><pre class="source lang-java linenums">package dqetool.mysql.gen;

import java.sql.SQLException;
import java.util.List;
import java.util.stream.Collectors;

import dqetool.Randomly;
import dqetool.common.query.ExpectedErrors;
import dqetool.common.query.SQLQueryAdapter;
import dqetool.mysql.MySQLGlobalState;
import dqetool.mysql.MySQLSchema.MySQLColumn;
import dqetool.mysql.MySQLSchema.MySQLTable;
import dqetool.mysql.MySQLVisitor;

public class MySQLInsertGenerator {

    private final MySQLTable table;
<span class="nc" id="L18">    private final StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L19">    private final ExpectedErrors errors = new ExpectedErrors();</span>
    private final MySQLGlobalState globalState;

<span class="nc" id="L22">    public MySQLInsertGenerator(MySQLGlobalState globalState) {</span>
<span class="nc" id="L23">        this.globalState = globalState;</span>
<span class="nc" id="L24">        table = globalState.getSchema().getRandomTable();</span>
<span class="nc" id="L25">    }</span>

    public static SQLQueryAdapter insertRow(MySQLGlobalState globalState) throws SQLException {
<span class="nc bnc" id="L28" title="All 2 branches missed.">        if (Randomly.getBoolean()) {</span>
<span class="nc" id="L29">            return new MySQLInsertGenerator(globalState).generateInsert();</span>
        } else {
<span class="nc" id="L31">            return new MySQLInsertGenerator(globalState).generateReplace();</span>
        }
    }

    private SQLQueryAdapter generateReplace() {
<span class="nc" id="L36">        sb.append(&quot;REPLACE&quot;);</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">        if (Randomly.getBoolean()) {</span>
<span class="nc" id="L38">            sb.append(&quot; &quot;);</span>
<span class="nc" id="L39">            sb.append(Randomly.fromOptions(&quot;LOW_PRIORITY&quot;, &quot;DELAYED&quot;));</span>
        }
<span class="nc" id="L41">        return generateInto();</span>

    }

    private SQLQueryAdapter generateInsert() {
<span class="nc" id="L46">        sb.append(&quot;INSERT&quot;);</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">        if (Randomly.getBoolean()) {</span>
<span class="nc" id="L48">            sb.append(&quot; &quot;);</span>
<span class="nc" id="L49">            sb.append(Randomly.fromOptions(&quot;LOW_PRIORITY&quot;, &quot;DELAYED&quot;, &quot;HIGH_PRIORITY&quot;));</span>
        }
<span class="nc bnc" id="L51" title="All 2 branches missed.">        if (Randomly.getBoolean()) {</span>
<span class="nc" id="L52">            sb.append(&quot; IGNORE&quot;);</span>
        }
<span class="nc" id="L54">        return generateInto();</span>
    }

    private SQLQueryAdapter generateInto() {
<span class="nc" id="L58">        sb.append(&quot; INTO &quot;);</span>
<span class="nc" id="L59">        sb.append(table.getName());</span>
<span class="nc" id="L60">        List&lt;MySQLColumn&gt; columns = table.getRandomNonEmptyColumnSubset();</span>
<span class="nc" id="L61">        sb.append(&quot;(&quot;);</span>
<span class="nc" id="L62">        sb.append(columns.stream().map(c -&gt; c.getName()).collect(Collectors.joining(&quot;, &quot;)));</span>
<span class="nc" id="L63">        sb.append(&quot;) &quot;);</span>
<span class="nc" id="L64">        sb.append(&quot;VALUES&quot;);</span>
<span class="nc" id="L65">        MySQLExpressionGenerator gen = new MySQLExpressionGenerator(globalState);</span>
        int nrRows;
<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (Randomly.getBoolean()) {</span>
<span class="nc" id="L68">            nrRows = 1;</span>
<span class="nc" id="L69">        } else {</span>
<span class="nc" id="L70">            nrRows = 1 + Randomly.smallNumber();</span>
        }
<span class="nc bnc" id="L72" title="All 2 branches missed.">        for (int row = 0; row &lt; nrRows; row++) {</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">            if (row != 0) {</span>
<span class="nc" id="L74">                sb.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L76">            sb.append(&quot;(&quot;);</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">            for (int c = 0; c &lt; columns.size(); c++) {</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">                if (c != 0) {</span>
<span class="nc" id="L79">                    sb.append(&quot;, &quot;);</span>
                }
<span class="nc" id="L81">                sb.append(MySQLVisitor.asString(gen.generateConstant()));</span>

            }
<span class="nc" id="L84">            sb.append(&quot;)&quot;);</span>
        }
<span class="nc" id="L86">        errors.add(&quot;doesn't have a default value&quot;);</span>
<span class="nc" id="L87">        errors.add(&quot;Data truncation&quot;);</span>
<span class="nc" id="L88">        errors.add(&quot;Incorrect integer value&quot;);</span>
<span class="nc" id="L89">        errors.add(&quot;Duplicate entry&quot;);</span>
<span class="nc" id="L90">        errors.add(&quot;Data truncated for functional index&quot;);</span>
<span class="nc" id="L91">        errors.add(&quot;Data truncated for column&quot;);</span>
<span class="nc" id="L92">        errors.add(&quot;cannot be null&quot;);</span>
<span class="nc" id="L93">        errors.add(&quot;Incorrect decimal value&quot;);</span>
<span class="nc" id="L94">        return new SQLQueryAdapter(sb.toString(), errors);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>