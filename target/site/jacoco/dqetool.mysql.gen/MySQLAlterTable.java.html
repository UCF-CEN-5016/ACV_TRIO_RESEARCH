<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MySQLAlterTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.mysql.gen</a> &gt; <span class="el_source">MySQLAlterTable.java</span></div><h1>MySQLAlterTable.java</h1><pre class="source lang-java linenums">package dqetool.mysql.gen;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

import dqetool.Randomly;
import dqetool.common.query.ExpectedErrors;
import dqetool.common.query.SQLQueryAdapter;
import dqetool.mysql.MySQLBugs;
import dqetool.mysql.MySQLGlobalState;
import dqetool.mysql.MySQLSchema;
import dqetool.mysql.MySQLSchema.MySQLTable;

<span class="nc" id="L16">public class MySQLAlterTable {</span>

    private final MySQLSchema schema;
<span class="nc" id="L19">    private final StringBuilder sb = new StringBuilder();</span>
    boolean couldAffectSchema;
    private List&lt;Action&gt; selectedActions;

<span class="nc" id="L23">    public MySQLAlterTable(MySQLSchema newSchema) {</span>
<span class="nc" id="L24">        this.schema = newSchema;</span>
<span class="nc" id="L25">    }</span>

    public static SQLQueryAdapter create(MySQLGlobalState globalState) {
<span class="nc" id="L28">        return new MySQLAlterTable(globalState.getSchema()).create();</span>
    }

<span class="nc" id="L31">    private enum Action {</span>
<span class="nc" id="L32">        ALGORITHM, //</span>
<span class="nc" id="L33">        CHECKSUM, //</span>
<span class="nc" id="L34">        COMPRESSION, //</span>
<span class="nc" id="L35">        DISABLE_ENABLE_KEYS(&quot;Data truncated for functional index&quot;), /* ignore due to http://bugs.mysql.com/?id=96295 */</span>
<span class="nc" id="L36">        DROP_COLUMN(&quot;Cannot drop column&quot;, &quot;ALGORITHM=INPLACE is not supported.&quot;, &quot;ALGORITHM=INSTANT is not supported.&quot;,</span>
<span class="nc" id="L37">                &quot;Duplicate entry&quot;, &quot;has a partitioning function dependency and cannot be dropped or renamed.&quot;,</span>
<span class="nc" id="L38">                &quot;A primary key index cannot be invisible&quot; /*</span>
                                                           * this error should not occur, see
                                                           * https://bugs.mysql.com/bug.php?id=95897
                                                           */,
<span class="nc" id="L42">                &quot;Field in list of fields for partition function not found in table&quot;, &quot;in 'partition function'&quot;,</span>
<span class="nc" id="L43">                &quot;has a functional index dependency and cannot be dropped or renamed.&quot;),</span>
<span class="nc" id="L44">        FORCE, //</span>
        // ORDER_BY is supported, see below
<span class="nc" id="L46">        DELAY_KEY_WRITE, //</span>
<span class="nc" id="L47">        INSERT_METHOD, //</span>
<span class="nc" id="L48">        ROW_FORMAT, //</span>
<span class="nc" id="L49">        STATS_AUTO_RECALC, //</span>
<span class="nc" id="L50">        STATS_PERSISTENT, //</span>
<span class="nc" id="L51">        PACK_KEYS, RENAME(&quot;doesn't exist&quot;, &quot;already exists&quot;), /* WITH_WITHOUT_VALIDATION , */</span>
<span class="nc" id="L52">        DROP_PRIMARY_KEY(</span>
<span class="nc" id="L53">                &quot;ALGORITHM=INSTANT is not supported. Reason: Dropping a primary key is not allowed without also adding a new primary key. Try ALGORITHM=COPY/INPLACE.&quot;);</span>

        private String[] potentialErrors;

<span class="nc" id="L57">        Action(String... couldCauseErrors) {</span>
<span class="nc" id="L58">            this.potentialErrors = couldCauseErrors.clone();</span>
<span class="nc" id="L59">        }</span>

    }

    private SQLQueryAdapter create() {
<span class="nc" id="L64">        ExpectedErrors errors = ExpectedErrors.from(&quot;does not support the create option&quot;, &quot;doesn't have this option&quot;,</span>
<span class="nc" id="L65">                &quot;is not supported for this operation&quot;, &quot;Data truncation&quot;, &quot;Specified key was too long&quot;);</span>
<span class="nc" id="L66">        errors.add(&quot;Data truncated for functional index &quot;);</span>
<span class="nc" id="L67">        sb.append(&quot;ALTER TABLE &quot;);</span>
<span class="nc" id="L68">        MySQLTable table = schema.getRandomTable();</span>
<span class="nc" id="L69">        sb.append(table.getName());</span>
<span class="nc" id="L70">        sb.append(&quot; &quot;);</span>
<span class="nc" id="L71">        List&lt;Action&gt; list = new ArrayList&lt;&gt;(Arrays.asList(Action.values()));</span>
<span class="nc bnc" id="L72" title="All 4 branches missed.">        if (!table.hasPrimaryKey() || MySQLBugs.bug95894) {</span>
<span class="nc" id="L73">            list.remove(Action.DROP_PRIMARY_KEY);</span>
        }
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (table.getColumns().size() == 1) {</span>
<span class="nc" id="L76">            list.remove(Action.DROP_COLUMN);</span>
        }
<span class="nc" id="L78">        selectedActions = Randomly.subset(list);</span>
<span class="nc" id="L79">        int i = 0;</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">        for (Action a : selectedActions) {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">            if (i++ != 0) {</span>
<span class="nc" id="L82">                sb.append(&quot;, &quot;);</span>
            }
<span class="nc bnc" id="L84" title="All 15 branches missed.">            switch (a) {</span>
            case ALGORITHM:
<span class="nc" id="L86">                sb.append(&quot;ALGORITHM &quot;);</span>
<span class="nc" id="L87">                sb.append(Randomly.fromOptions(&quot;INSTANT&quot;, &quot;INPLACE&quot;, &quot;COPY&quot;, &quot;DEFAULT&quot;));</span>
<span class="nc" id="L88">                break;</span>
            case CHECKSUM:
<span class="nc" id="L90">                sb.append(&quot;CHECKSUM &quot;);</span>
<span class="nc" id="L91">                sb.append(Randomly.fromOptions(0, 1));</span>
<span class="nc" id="L92">                break;</span>
            case COMPRESSION:
<span class="nc" id="L94">                sb.append(&quot;COMPRESSION &quot;);</span>
<span class="nc" id="L95">                sb.append(&quot;'&quot;);</span>
<span class="nc" id="L96">                sb.append(Randomly.fromOptions(&quot;ZLIB&quot;, &quot;LZ4&quot;, &quot;NONE&quot;));</span>
<span class="nc" id="L97">                sb.append(&quot;'&quot;);</span>
<span class="nc" id="L98">                break;</span>
            case DELAY_KEY_WRITE:
<span class="nc" id="L100">                sb.append(&quot;DELAY_KEY_WRITE &quot;);</span>
<span class="nc" id="L101">                sb.append(Randomly.fromOptions(0, 1));</span>
<span class="nc" id="L102">                break;</span>
            case DROP_COLUMN:
<span class="nc" id="L104">                sb.append(&quot;DROP &quot;);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                if (Randomly.getBoolean()) {</span>
<span class="nc" id="L106">                    sb.append(&quot;COLUMN &quot;);</span>
                }
<span class="nc" id="L108">                sb.append(table.getRandomColumn().getName());</span>
<span class="nc" id="L109">                couldAffectSchema = true;</span>
<span class="nc" id="L110">                break;</span>
            case DISABLE_ENABLE_KEYS:
<span class="nc" id="L112">                sb.append(Randomly.fromOptions(&quot;DISABLE&quot;, &quot;ENABLE&quot;));</span>
<span class="nc" id="L113">                sb.append(&quot; KEYS&quot;);</span>
<span class="nc" id="L114">                break;</span>
            case DROP_PRIMARY_KEY:
<span class="nc bnc" id="L116" title="All 2 branches missed.">                assert table.hasPrimaryKey();</span>
<span class="nc" id="L117">                sb.append(&quot;DROP PRIMARY KEY&quot;);</span>
<span class="nc" id="L118">                couldAffectSchema = true;</span>
<span class="nc" id="L119">                break;</span>
            case FORCE:
<span class="nc" id="L121">                sb.append(&quot;FORCE&quot;);</span>
<span class="nc" id="L122">                break;</span>
            case INSERT_METHOD:
<span class="nc" id="L124">                sb.append(&quot;INSERT_METHOD &quot;);</span>
<span class="nc" id="L125">                sb.append(Randomly.fromOptions(&quot;NO&quot;, &quot;FIRST&quot;, &quot;LAST&quot;));</span>
<span class="nc" id="L126">                break;</span>
            case ROW_FORMAT:
<span class="nc" id="L128">                sb.append(&quot;ROW_FORMAT &quot;);</span>
<span class="nc" id="L129">                sb.append(Randomly.fromOptions(&quot;DEFAULT&quot;, &quot;DYNAMIC&quot;, &quot;FIXED&quot;, &quot;COMPRESSED&quot;, &quot;REDUNDANT&quot;, &quot;COMPACT&quot;));</span>
<span class="nc" id="L130">                break;</span>
            case STATS_AUTO_RECALC:
<span class="nc" id="L132">                sb.append(&quot;STATS_AUTO_RECALC &quot;);</span>
<span class="nc" id="L133">                sb.append(Randomly.fromOptions(0, 1, &quot;DEFAULT&quot;));</span>
<span class="nc" id="L134">                break;</span>
            case STATS_PERSISTENT:
<span class="nc" id="L136">                sb.append(&quot;STATS_PERSISTENT &quot;);</span>
<span class="nc" id="L137">                sb.append(Randomly.fromOptions(0, 1, &quot;DEFAULT&quot;));</span>
<span class="nc" id="L138">                break;</span>
            case PACK_KEYS:
<span class="nc" id="L140">                sb.append(&quot;PACK_KEYS &quot;);</span>
<span class="nc" id="L141">                sb.append(Randomly.fromOptions(0, 1, &quot;DEFAULT&quot;));</span>
<span class="nc" id="L142">                break;</span>
            // not relevant:
            // case WITH_WITHOUT_VALIDATION:
            // sb.append(Randomly.fromOptions(&quot;WITHOUT&quot;, &quot;WITH&quot;));
            // sb.append(&quot; VALIDATION&quot;);
            // break;
            case RENAME:
<span class="nc" id="L149">                sb.append(&quot;RENAME &quot;);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                if (Randomly.getBoolean()) {</span>
<span class="nc" id="L151">                    sb.append(Randomly.fromOptions(&quot;TO&quot;, &quot;AS&quot;));</span>
<span class="nc" id="L152">                    sb.append(&quot; &quot;);</span>
                }
<span class="nc" id="L154">                sb.append(&quot;t&quot;);</span>
<span class="nc" id="L155">                sb.append(Randomly.smallNumber());</span>
<span class="nc" id="L156">                couldAffectSchema = true;</span>
<span class="nc" id="L157">                break;</span>
            default:
<span class="nc" id="L159">                throw new AssertionError(a);</span>
            }
        }
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (Randomly.getBooleanWithSmallProbability()) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            if (i != 0) {</span>
<span class="nc" id="L164">                sb.append(&quot;, &quot;);</span>
            }
            // should be given as last option
<span class="nc" id="L167">            sb.append(&quot; ORDER BY &quot;);</span>
<span class="nc" id="L168">            sb.append(table.getRandomNonEmptyColumnSubset().stream().map(c -&gt; c.getName())</span>
<span class="nc" id="L169">                    .collect(Collectors.joining(&quot;, &quot;)));</span>
        }
<span class="nc bnc" id="L171" title="All 2 branches missed.">        for (Action a : selectedActions) {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            for (String error : a.potentialErrors) {</span>
<span class="nc" id="L173">                errors.add(error);</span>
            }
        }
<span class="nc" id="L176">        return new SQLQueryAdapter(sb.toString(), errors, couldAffectSchema);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>