<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SQLite3Function.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.sqlite3.ast</a> &gt; <span class="el_source">SQLite3Function.java</span></div><h1>SQLite3Function.java</h1><pre class="source lang-java linenums">package dqetool.sqlite3.ast;

import dqetool.IgnoreMeException;
import dqetool.Randomly;
import dqetool.sqlite3.ast.SQLite3Constant.SQLite3TextConstant;
import dqetool.sqlite3.schema.SQLite3DataType;
import dqetool.sqlite3.schema.SQLite3Schema.SQLite3Column.SQLite3CollateSequence;

public class SQLite3Function extends SQLite3Expression {

    private final ComputableFunction func;
    private final SQLite3Expression[] args;

<span class="nc" id="L14">    public SQLite3Function(ComputableFunction func, SQLite3Expression... args) {</span>
<span class="nc" id="L15">        this.func = func;</span>
<span class="nc" id="L16">        this.args = args.clone();</span>
<span class="nc" id="L17">    }</span>

    public enum ComputableFunction {

<span class="nc" id="L21">        ABS(1, &quot;ABS&quot;) {</span>
            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
                SQLite3Constant castValue;
<span class="nc bnc" id="L25" title="All 2 branches missed.">                if (args[0].getDataType() == SQLite3DataType.BINARY) {</span>
<span class="nc" id="L26">                    throw new IgnoreMeException(); // TODO</span>
                                                   // implement
                }
<span class="nc bnc" id="L29" title="All 2 branches missed.">                if (args[0].getDataType() == SQLite3DataType.INT) {</span>
<span class="nc" id="L30">                    castValue = SQLite3Cast.castToInt(args[0]);</span>
<span class="nc" id="L31">                } else {</span>
<span class="nc" id="L32">                    castValue = SQLite3Cast.castToNumericNoNumAsRealZero(args[0]);</span>
                }
<span class="nc bnc" id="L34" title="All 2 branches missed.">                if (castValue.isNull()) {</span>
<span class="nc" id="L35">                    return castValue;</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">                } else if (castValue.getDataType() == SQLite3DataType.INT) {</span>
<span class="nc" id="L37">                    long absVal = Math.abs(castValue.asInt());</span>
<span class="nc" id="L38">                    return SQLite3Constant.createIntConstant(absVal);</span>
                } else {
<span class="nc bnc" id="L40" title="All 4 branches missed.">                    assert castValue.getDataType() == SQLite3DataType.REAL;</span>
<span class="nc" id="L41">                    double absVal = Math.abs(castValue.asDouble());</span>
<span class="nc" id="L42">                    return SQLite3Constant.createRealConstant(absVal);</span>
                }
            }
        },

<span class="nc" id="L47">        COALESCE(2, &quot;COALESCE&quot;) {</span>

            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
<span class="nc bnc" id="L51" title="All 2 branches missed.">                for (SQLite3Constant arg : args) {</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">                    if (!arg.isNull()) {</span>
<span class="nc" id="L53">                        return arg;</span>
                    }
                }
<span class="nc" id="L56">                return SQLite3Constant.createNullConstant();</span>
            }

            @Override
            public boolean isVariadic() {
<span class="nc" id="L61">                return true;</span>
            }

        },

<span class="nc" id="L66">        HEX(1, &quot;HEX&quot;) {</span>
            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
<span class="nc" id="L69">                return null;</span>
                // SQLite3Constant binaryValue = SQLite3Cast.castToBlob(args[0]);
                // return
                // SQLite3Constant.createTextConstant(binaryValue.getStringRepresentation());
            }
        },

<span class="nc" id="L76">        LOWER(1, &quot;LOWER&quot;) {</span>
            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
<span class="nc" id="L79">                args[0] = SQLite3Cast.castToText(args[0]);</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">                if (args[0] == null) {</span>
<span class="nc" id="L81">                    return null;</span>
                }
<span class="nc bnc" id="L83" title="All 2 branches missed.">                if (args[0].getDataType() == SQLite3DataType.TEXT) {</span>
<span class="nc" id="L84">                    StringBuilder text = new StringBuilder(args[0].asString());</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    for (int i = 0; i &lt; text.length(); i++) {</span>
<span class="nc" id="L86">                        char c = text.charAt(i);</span>
<span class="nc bnc" id="L87" title="All 4 branches missed.">                        if (c &gt;= 'A' &amp;&amp; c &lt;= 'Z') {</span>
<span class="nc" id="L88">                            text.setCharAt(i, Character.toLowerCase(c));</span>
                        }
                    }
<span class="nc" id="L91">                    return SQLite3Constant.createTextConstant(text.toString());</span>
                } else {
<span class="nc" id="L93">                    return SQLite3Constant.createNullConstant();</span>
                }
            }
        },
<span class="nc" id="L97">        LIKELY(1, &quot;LIKELY&quot;) {</span>
            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
<span class="nc" id="L100">                return args[0];</span>
            }

        },
<span class="nc" id="L104">        LIKELIHOOD(2, &quot;LIKELIHOOD&quot;) {</span>
            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
<span class="nc" id="L107">                return args[0];</span>
            }

        },
<span class="nc" id="L111">        IFNULL(2, &quot;IFNULL&quot;) {</span>
            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
<span class="nc bnc" id="L114" title="All 2 branches missed.">                for (SQLite3Expression arg : args) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                    if (!arg.getExpectedValue().isNull()) {</span>
<span class="nc" id="L116">                        return arg.getExpectedValue();</span>
                    }
                }
<span class="nc" id="L119">                return SQLite3Constant.createNullConstant();</span>
            }
        },

<span class="nc" id="L123">        UPPER(1, &quot;UPPER&quot;) {</span>

            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
<span class="nc" id="L127">                args[0] = SQLite3Cast.castToText(args[0]);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                if (args[0] == null) {</span>
<span class="nc" id="L129">                    return null;</span>
                }
<span class="nc bnc" id="L131" title="All 2 branches missed.">                if (args[0].getDataType() == SQLite3DataType.TEXT) {</span>
<span class="nc" id="L132">                    String string = SQLite3TextConstant.toUpper(args[0].asString());</span>
<span class="nc" id="L133">                    return SQLite3Constant.createTextConstant(string);</span>
                } else {
<span class="nc" id="L135">                    return SQLite3Constant.createNullConstant();</span>
                }
            }

        },
<span class="nc" id="L140">        NULLIF(2, &quot;NULLIF&quot;) {</span>
            @Override
            public SQLite3Constant apply(SQLite3Constant[] args, SQLite3CollateSequence collateSequence) {
<span class="nc" id="L143">                SQLite3Constant equals = args[0].applyEquals(args[1],</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                        collateSequence == null ? SQLite3CollateSequence.BINARY : collateSequence);</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">                if (SQLite3Cast.isTrue(equals).isPresent() &amp;&amp; SQLite3Cast.isTrue(equals).get()) {</span>
<span class="nc" id="L146">                    return SQLite3Constant.createNullConstant();</span>
                } else {
<span class="nc" id="L148">                    return args[0];</span>
                }
            }

            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
<span class="nc" id="L154">                SQLite3CollateSequence collateSequence = null;</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                for (SQLite3Constant con : args) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                    if (con.getExplicitCollateSequence() != null) {</span>
<span class="nc" id="L157">                        collateSequence = con.getExplicitCollateSequence();</span>
<span class="nc" id="L158">                        break;</span>
                    }
                }
<span class="nc bnc" id="L161" title="All 2 branches missed.">                if (collateSequence == null) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                    for (SQLite3Constant con : args) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                        if (con.getImplicitCollateSequence() != null) {</span>
<span class="nc" id="L164">                            collateSequence = con.getImplicitCollateSequence();</span>
<span class="nc" id="L165">                            break;</span>
                        }
                    }
                }
<span class="nc" id="L169">                return apply(args, collateSequence);</span>
            }
        },
<span class="nc" id="L172">        TRIM(1, &quot;TRIM&quot;) {</span>

            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
<span class="nc" id="L176">                SQLite3Constant str = SQLite3Cast.castToText(args[0]);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                if (args[0].getDataType() == SQLite3DataType.TEXT) {</span>
<span class="nc" id="L178">                    String text = str.asString();</span>
<span class="nc" id="L179">                    return SQLite3Constant.createTextConstant(SQLite3TextConstant.trim(text));</span>
                } else {
<span class="nc" id="L181">                    return str;</span>
                }
            }

        },
<span class="nc" id="L186">        TRIM_TWO_ARGS(2, &quot;TRIM&quot;) {</span>

            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
<span class="nc bnc" id="L190" title="All 4 branches missed.">                if (args[0].isNull() || args[1].isNull()) {</span>
<span class="nc" id="L191">                    return SQLite3Constant.createNullConstant();</span>
                }
<span class="nc" id="L193">                SQLite3Constant str = SQLite3Cast.castToText(args[0]);</span>
<span class="nc" id="L194">                SQLite3Constant castToText = SQLite3Cast.castToText(args[1]);</span>
<span class="nc bnc" id="L195" title="All 4 branches missed.">                if (str == null || castToText == null) {</span>
<span class="nc" id="L196">                    return null;</span>
                }
<span class="nc" id="L198">                String remove = castToText.asString();</span>
<span class="nc" id="L199">                StringBuilder text = new StringBuilder(str.asString());</span>
<span class="nc" id="L200">                int i = 0;</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                while (i &lt; text.length()) {</span>
<span class="nc" id="L202">                    boolean shouldRemoveChar = false;</span>
<span class="nc" id="L203">                    char c = text.charAt(i);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                    for (char charToRemove : remove.toCharArray()) {</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                        if (charToRemove == c) {</span>
<span class="nc" id="L206">                            shouldRemoveChar = true;</span>
<span class="nc" id="L207">                            break;</span>
                        }
                    }
<span class="nc bnc" id="L210" title="All 2 branches missed.">                    if (shouldRemoveChar) {</span>
<span class="nc" id="L211">                        text.deleteCharAt(i);</span>
                    } else {
                        break;
                    }
                }
<span class="nc" id="L216">                i = text.length() - 1;</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">                while (i &gt;= 0) {</span>
<span class="nc" id="L218">                    boolean shouldRemoveChar = false;</span>
<span class="nc" id="L219">                    char c = text.charAt(i);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                    for (char charToRemove : remove.toCharArray()) {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                        if (charToRemove == c) {</span>
<span class="nc" id="L222">                            shouldRemoveChar = true;</span>
<span class="nc" id="L223">                            break;</span>
                        }
                    }
<span class="nc bnc" id="L226" title="All 2 branches missed.">                    if (shouldRemoveChar) {</span>
<span class="nc" id="L227">                        text.deleteCharAt(i);</span>
<span class="nc" id="L228">                        i--;</span>
                    } else {
                        break;
                    }
                }
<span class="nc" id="L233">                String string = text.toString();</span>
<span class="nc bnc" id="L234" title="All 4 branches missed.">                assert string != null;</span>
<span class="nc" id="L235">                return SQLite3Constant.createTextConstant(string);</span>
            }
        },
<span class="nc" id="L238">        TYPEOF(1, &quot;TYPEOF&quot;) {</span>

            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
<span class="nc bnc" id="L242" title="All 6 branches missed.">                switch (args[0].getDataType()) {</span>
                case BINARY:
<span class="nc" id="L244">                    return SQLite3Constant.createTextConstant(&quot;blob&quot;);</span>
                case INT:
<span class="nc" id="L246">                    return SQLite3Constant.createTextConstant(&quot;integer&quot;);</span>
                case NULL:
<span class="nc" id="L248">                    return SQLite3Constant.createTextConstant(&quot;null&quot;);</span>
                case REAL:
<span class="nc" id="L250">                    return SQLite3Constant.createTextConstant(&quot;real&quot;);</span>
                case TEXT:
<span class="nc" id="L252">                    return SQLite3Constant.createTextConstant(&quot;text&quot;);</span>
                default:
<span class="nc" id="L254">                    throw new AssertionError(args[0]);</span>
                }
            }

        },
<span class="nc" id="L259">        UNLIKELY(1, &quot;UNLIKELY&quot;) {</span>
            @Override
            public SQLite3Constant apply(SQLite3Constant... args) {
<span class="nc" id="L262">                return args[0];</span>
            }

        };

        private String functionName;
        final int nrArgs;

<span class="nc" id="L270">        ComputableFunction(int nrArgs, String functionName) {</span>
<span class="nc" id="L271">            this.nrArgs = nrArgs;</span>
<span class="nc" id="L272">            this.functionName = functionName;</span>
<span class="nc" id="L273">        }</span>

        /**
         * Gets the number of arguments if the function is non-variadic. If the function is variadic, the minimum number
         * of arguments is returned.
         *
         * @return the number of arguments
         */
        public int getNrArgs() {
<span class="nc" id="L282">            return nrArgs;</span>
        }

        public abstract SQLite3Constant apply(SQLite3Constant... args);

        public SQLite3Constant apply(SQLite3Constant[] evaluatedArgs, SQLite3CollateSequence collate) {
<span class="nc" id="L288">            return apply(evaluatedArgs);</span>
        }

        public static ComputableFunction getRandomFunction() {
<span class="nc" id="L292">            return Randomly.fromOptions(ComputableFunction.values());</span>
        }

        @Override
        public String toString() {
<span class="nc" id="L297">            return functionName;</span>
        }

        public boolean isVariadic() {
<span class="nc" id="L301">            return false;</span>
        }

        public TypeAffinity getAffinity(SQLite3Expression... args) {
<span class="nc" id="L305">            return TypeAffinity.NONE;</span>
        }

    }

    @Override
    public SQLite3CollateSequence getExplicitCollateSequence() {
<span class="nc bnc" id="L312" title="All 2 branches missed.">        for (SQLite3Expression expr : args) {</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">            if (expr.getExplicitCollateSequence() != null) {</span>
<span class="nc" id="L314">                return expr.getExplicitCollateSequence();</span>
            }
        }
<span class="nc" id="L317">        return null;</span>
    }

    public SQLite3Expression[] getArgs() {
<span class="nc" id="L321">        return args.clone();</span>
    }

    public ComputableFunction getFunc() {
<span class="nc" id="L325">        return func;</span>
    }

    @Override
    public SQLite3Constant getExpectedValue() {
<span class="nc" id="L330">        SQLite3Constant[] constants = new SQLite3Constant[args.length];</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">        for (int i = 0; i &lt; constants.length; i++) {</span>
<span class="nc" id="L332">            constants[i] = args[i].getExpectedValue();</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">            if (constants[i] == null) {</span>
<span class="nc" id="L334">                return null;</span>
            }
        }
<span class="nc" id="L337">        SQLite3CollateSequence collate = getExplicitCollateSequence();</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (collate == null) {</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">            for (SQLite3Expression arg : args) {</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">                if (arg.getImplicitCollateSequence() != null) {</span>
<span class="nc" id="L341">                    collate = arg.getImplicitCollateSequence();</span>
<span class="nc" id="L342">                    break;</span>
                }
            }
        }
<span class="nc" id="L346">        return func.apply(constants, collate);</span>

    };

    @Override
    public TypeAffinity getAffinity() {
<span class="nc" id="L352">        return func.getAffinity(args);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>