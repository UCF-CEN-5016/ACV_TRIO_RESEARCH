<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SQLite3Common.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.sqlite3.gen</a> &gt; <span class="el_source">SQLite3Common.java</span></div><h1>SQLite3Common.java</h1><pre class="source lang-java linenums">package dqetool.sqlite3.gen;

import java.util.ArrayList;
import java.util.List;

import dqetool.Randomly;
import dqetool.common.DBMSCommon;
import dqetool.sqlite3.SQLite3GlobalState;
import dqetool.sqlite3.SQLite3Visitor;
import dqetool.sqlite3.ast.SQLite3Expression;
import dqetool.sqlite3.ast.SQLite3Expression.SQLite3TableReference;
import dqetool.sqlite3.schema.SQLite3DataType;
import dqetool.sqlite3.schema.SQLite3Schema;
import dqetool.sqlite3.schema.SQLite3Schema.SQLite3Column;
import dqetool.sqlite3.schema.SQLite3Schema.SQLite3Table;

public final class SQLite3Common {

    private SQLite3Common() {
    }

    public static String getRandomCollate() {
<span class="nc" id="L23">        return Randomly.fromOptions(&quot; COLLATE BINARY&quot;, &quot; COLLATE RTRIM&quot;, &quot; COLLATE NOCASE&quot;/* , &quot; COLLATE UINT&quot; */);</span>
    }

    public static String getCheckConstraint(SQLite3GlobalState globalState, List&lt;SQLite3Column&gt; columns) {
<span class="nc" id="L27">        SQLite3Expression expression = new SQLite3ExpressionGenerator(globalState).setColumns(columns)</span>
<span class="nc" id="L28">                .generateExpression();</span>
<span class="nc" id="L29">        return &quot; CHECK ( &quot; + SQLite3Visitor.asString(expression) + &quot;)&quot;;</span>
    }

    // TODO: refactor others to use this method
    // https://www.sqlite.org/syntax/ordering-term.html
    public static String getOrderingTerm(List&lt;SQLite3Column&gt; columns, SQLite3GlobalState globalState) {
<span class="nc" id="L35">        SQLite3Expression randExpr = new SQLite3ExpressionGenerator(globalState).setColumns(columns)</span>
<span class="nc" id="L36">                .generateExpression();</span>
<span class="nc" id="L37">        StringBuilder sb = new StringBuilder(SQLite3Visitor.asString(randExpr));</span>
<span class="nc" id="L38">        sb.append(&quot; &quot;);</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">        if (Randomly.getBoolean()) {</span>
<span class="nc" id="L40">            sb.append(SQLite3Common.getRandomCollate());</span>
        }
<span class="nc bnc" id="L42" title="All 2 branches missed.">        if (Randomly.getBoolean()) {</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">            if (Randomly.getBoolean()) {</span>
<span class="nc" id="L44">                sb.append(&quot; ASC&quot;);</span>
<span class="nc" id="L45">            } else {</span>
<span class="nc" id="L46">                sb.append(&quot; DESC&quot;);</span>
            }
        }
<span class="nc" id="L49">        return sb.toString();</span>
    }

    public static String getIndexedClause(String indexName) {
<span class="nc" id="L53">        StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">        if (Randomly.getBoolean()) {</span>
<span class="nc" id="L55">            sb.append(&quot;INDEXED BY &quot;);</span>
<span class="nc" id="L56">            sb.append(indexName);</span>
<span class="nc" id="L57">        } else {</span>
<span class="nc" id="L58">            sb.append(&quot;NOT INDEXED&quot;);</span>
        }
<span class="nc" id="L60">        return sb.toString();</span>
    }

    public static String getFreeTableName(SQLite3Schema s) {
<span class="nc" id="L64">        int nr = 0;</span>
<span class="nc" id="L65">        String[] name = new String[1];</span>
        do {
<span class="nc" id="L67">            name[0] = DBMSCommon.createTableName(nr++);</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        } while (s.getDatabaseTables().stream().anyMatch(tab -&gt; tab.getName().contentEquals(name[0])));</span>
<span class="nc" id="L69">        return name[0];</span>
    }

    public static String getFreeViewName(SQLite3Schema s) {
<span class="nc" id="L73">        int nr = 0;</span>
<span class="nc" id="L74">        String[] name = new String[1];</span>
        do {
<span class="nc" id="L76">            name[0] = &quot;v&quot; + nr++;</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        } while (s.getDatabaseTables().stream().anyMatch(tab -&gt; tab.getName().contentEquals(name[0])));</span>
<span class="nc" id="L78">        return name[0];</span>
    }

    public static String getFreeIndexName(SQLite3Schema s) {
<span class="nc" id="L82">        List&lt;String&gt; indexNames = s.getIndexNames();</span>
        String candidateName;
        do {
<span class="nc" id="L85">            candidateName = DBMSCommon.createIndexName((int) Randomly.getNotCachedInteger(0, 100));</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        } while (indexNames.contains(candidateName));</span>
<span class="nc" id="L87">        return candidateName;</span>
    }

    public static String getFreeColumnName(SQLite3Table t) {
<span class="nc" id="L91">        List&lt;SQLite3Column&gt; indexNames = t.getColumns();</span>
<span class="nc" id="L92">        final String[] candidateName = new String[1];</span>
        do {
<span class="nc" id="L94">            candidateName[0] = DBMSCommon.createColumnName((int) Randomly.getNotCachedInteger(0, 100));</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        } while (indexNames.stream().anyMatch(c -&gt; c.getName().contentEquals(candidateName[0])));</span>
<span class="nc" id="L96">        return candidateName[0];</span>
    }

    public static String getOrderByAsString(List&lt;SQLite3Column&gt; columns, SQLite3GlobalState globalState) {
<span class="nc" id="L100">        StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L101">        SQLite3ExpressionGenerator gen = new SQLite3ExpressionGenerator(globalState).setColumns(columns);</span>
<span class="nc" id="L102">        sb.append(&quot; ORDER BY &quot;);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        for (int i = 0; i &lt; Randomly.smallNumber() + 1; i++) {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (i != 0) {</span>
<span class="nc" id="L105">                sb.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L107">            sb.append(SQLite3Visitor.asString(gen.generateOrderingTerm()));</span>
        }
<span class="nc" id="L109">        return sb.toString();</span>
    }

    public static List&lt;SQLite3Expression&gt; getOrderBy(List&lt;SQLite3Column&gt; columns, SQLite3GlobalState globalState) {
<span class="nc" id="L113">        SQLite3ExpressionGenerator gen = new SQLite3ExpressionGenerator(globalState).setColumns(columns);</span>
<span class="nc" id="L114">        List&lt;SQLite3Expression&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        for (int i = 0; i &lt; 1 + Randomly.smallNumber(); i++) {</span>
<span class="nc" id="L116">            list.add(gen.generateOrderingTerm());</span>
        }
<span class="nc" id="L118">        return list;</span>

    }

    public static SQLite3Column createColumn(int i) {
<span class="nc" id="L123">        return new SQLite3Column(DBMSCommon.createColumnName(i), SQLite3DataType.NONE, false, false, null);</span>
    }

    public static List&lt;SQLite3Expression&gt; getTableRefs(List&lt;SQLite3Table&gt; tables, SQLite3Schema s) {
<span class="nc" id="L127">        List&lt;SQLite3Expression&gt; tableRefs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        for (SQLite3Table t : tables) {</span>
            SQLite3TableReference tableRef;
<span class="nc bnc" id="L130" title="All 4 branches missed.">            if (Randomly.getBooleanWithSmallProbability() &amp;&amp; !s.getIndexNames().isEmpty()) {</span>
<span class="nc" id="L131">                tableRef = new SQLite3TableReference(s.getRandomIndexOrBailout(), t);</span>
<span class="nc" id="L132">            } else {</span>
<span class="nc" id="L133">                tableRef = new SQLite3TableReference(t);</span>
            }
<span class="nc" id="L135">            tableRefs.add(tableRef);</span>
        }
<span class="nc" id="L137">        return tableRefs;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>