<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MySQLSchema.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.mysql</a> &gt; <span class="el_source">MySQLSchema.java</span></div><h1>MySQLSchema.java</h1><pre class="source lang-java linenums">package dqetool.mysql;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.SQLIntegrityConstraintViolationException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Stream;

import dqetool.Randomly;
import dqetool.SQLConnection;
import dqetool.common.schema.AbstractRelationalTable;
import dqetool.common.schema.AbstractRowValue;
import dqetool.common.schema.AbstractSchema;
import dqetool.common.schema.AbstractTableColumn;
import dqetool.common.schema.AbstractTables;
import dqetool.common.schema.TableIndex;
import dqetool.mysql.MySQLSchema.MySQLTable;
import dqetool.mysql.MySQLSchema.MySQLTable.MySQLEngine;
import dqetool.mysql.ast.MySQLConstant;

public class MySQLSchema extends AbstractSchema&lt;MySQLGlobalState, MySQLTable&gt; {

    private static final int NR_SCHEMA_READ_TRIES = 10;

<span class="nc" id="L29">    public enum MySQLDataType {</span>
<span class="nc" id="L30">        INT, VARCHAR, FLOAT, DOUBLE, DECIMAL;</span>

        public static MySQLDataType getRandom(MySQLGlobalState globalState) {
<span class="nc bnc" id="L33" title="All 2 branches missed.">            if (globalState.usesPQS()) {</span>
<span class="nc" id="L34">                return Randomly.fromOptions(MySQLDataType.INT, MySQLDataType.VARCHAR);</span>
            } else {
<span class="nc" id="L36">                return Randomly.fromOptions(values());</span>
            }
        }

        public boolean isNumeric() {
<span class="nc bnc" id="L41" title="All 3 branches missed.">            switch (this) {</span>
            case INT:
            case DOUBLE:
            case FLOAT:
            case DECIMAL:
<span class="nc" id="L46">                return true;</span>
            case VARCHAR:
<span class="nc" id="L48">                return false;</span>
            default:
<span class="nc" id="L50">                throw new AssertionError(this);</span>
            }
        }

    }

    public static class MySQLColumn extends AbstractTableColumn&lt;MySQLTable, MySQLDataType&gt; {

        private final boolean isPrimaryKey;
        private final int precision;

<span class="nc" id="L61">        public enum CollateSequence {</span>
<span class="nc" id="L62">            NOCASE, RTRIM, BINARY;</span>

            public static CollateSequence random() {
<span class="nc" id="L65">                return Randomly.fromOptions(values());</span>
            }
        }

        public MySQLColumn(String name, MySQLDataType columnType, boolean isPrimaryKey, int precision) {
<span class="nc" id="L70">            super(name, null, columnType);</span>
<span class="nc" id="L71">            this.isPrimaryKey = isPrimaryKey;</span>
<span class="nc" id="L72">            this.precision = precision;</span>
<span class="nc" id="L73">        }</span>

        public int getPrecision() {
<span class="nc" id="L76">            return precision;</span>
        }

        public boolean isPrimaryKey() {
<span class="nc" id="L80">            return isPrimaryKey;</span>
        }

    }

<span class="nc" id="L85">    public static class MySQLTables extends AbstractTables&lt;MySQLTable, MySQLColumn&gt; {</span>

        public MySQLTables(List&lt;MySQLTable&gt; tables) {
<span class="nc" id="L88">            super(tables);</span>
<span class="nc" id="L89">        }</span>

        public MySQLRowValue getRandomRowValue(SQLConnection con) throws SQLException {
<span class="nc" id="L92">            String randomRow = String.format(&quot;SELECT %s FROM %s ORDER BY RAND() LIMIT 1&quot;, columnNamesAsString(</span>
<span class="nc" id="L93">                    c -&gt; c.getTable().getName() + &quot;.&quot; + c.getName() + &quot; AS &quot; + c.getTable().getName() + c.getName()),</span>
                    // columnNamesAsString(c -&gt; &quot;typeof(&quot; + c.getTable().getName() + &quot;.&quot; +
                    // c.getName() + &quot;)&quot;)
<span class="nc" id="L96">                    tableNamesAsString());</span>
<span class="nc" id="L97">            Map&lt;MySQLColumn, MySQLConstant&gt; values = new HashMap&lt;&gt;();</span>
<span class="nc" id="L98">            try (Statement s = con.createStatement()) {</span>
<span class="nc" id="L99">                ResultSet randomRowValues = s.executeQuery(randomRow);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (!randomRowValues.next()) {</span>
<span class="nc" id="L101">                    throw new AssertionError(&quot;could not find random row! &quot; + randomRow + &quot;\n&quot;);</span>
                }
<span class="nc bnc" id="L103" title="All 2 branches missed.">                for (int i = 0; i &lt; getColumns().size(); i++) {</span>
<span class="nc" id="L104">                    MySQLColumn column = getColumns().get(i);</span>
                    Object value;
<span class="nc" id="L106">                    int columnIndex = randomRowValues.findColumn(column.getTable().getName() + column.getName());</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                    assert columnIndex == i + 1;</span>
                    MySQLConstant constant;
<span class="nc bnc" id="L109" title="All 2 branches missed.">                    if (randomRowValues.getString(columnIndex) == null) {</span>
<span class="nc" id="L110">                        constant = MySQLConstant.createNullConstant();</span>
<span class="nc" id="L111">                    } else {</span>
<span class="nc bnc" id="L112" title="All 3 branches missed.">                        switch (column.getType()) {</span>
                        case INT:
<span class="nc" id="L114">                            value = randomRowValues.getLong(columnIndex);</span>
<span class="nc" id="L115">                            constant = MySQLConstant.createIntConstant((long) value);</span>
<span class="nc" id="L116">                            break;</span>
                        case VARCHAR:
<span class="nc" id="L118">                            value = randomRowValues.getString(columnIndex);</span>
<span class="nc" id="L119">                            constant = MySQLConstant.createStringConstant((String) value);</span>
<span class="nc" id="L120">                            break;</span>
                        default:
<span class="nc" id="L122">                            throw new AssertionError(column.getType());</span>
                        }
                    }
<span class="nc" id="L125">                    values.put(column, constant);</span>
                }
<span class="nc bnc" id="L127" title="All 2 branches missed.">                assert !randomRowValues.next();</span>
<span class="nc" id="L128">                return new MySQLRowValue(this, values);</span>
            }

        }

    }

    private static MySQLDataType getColumnType(String typeString) {
<span class="nc bnc" id="L136" title="All 6 branches missed.">        switch (typeString) {</span>
        case &quot;tinyint&quot;:
        case &quot;smallint&quot;:
        case &quot;mediumint&quot;:
        case &quot;int&quot;:
        case &quot;bigint&quot;:
<span class="nc" id="L142">            return MySQLDataType.INT;</span>
        case &quot;varchar&quot;:
        case &quot;tinytext&quot;:
        case &quot;mediumtext&quot;:
        case &quot;text&quot;:
        case &quot;longtext&quot;:
<span class="nc" id="L148">            return MySQLDataType.VARCHAR;</span>
        case &quot;double&quot;:
<span class="nc" id="L150">            return MySQLDataType.DOUBLE;</span>
        case &quot;float&quot;:
<span class="nc" id="L152">            return MySQLDataType.FLOAT;</span>
        case &quot;decimal&quot;:
<span class="nc" id="L154">            return MySQLDataType.DECIMAL;</span>
        default:
<span class="nc" id="L156">            throw new AssertionError(typeString);</span>
        }
    }

    public static class MySQLRowValue extends AbstractRowValue&lt;MySQLTables, MySQLColumn, MySQLConstant&gt; {

        MySQLRowValue(MySQLTables tables, Map&lt;MySQLColumn, MySQLConstant&gt; values) {
<span class="nc" id="L163">            super(tables, values);</span>
<span class="nc" id="L164">        }</span>

    }

    public static class MySQLTable extends AbstractRelationalTable&lt;MySQLColumn, MySQLIndex, MySQLGlobalState&gt; {

<span class="nc" id="L170">        public enum MySQLEngine {</span>
<span class="nc" id="L171">            INNO_DB(&quot;InnoDB&quot;), MY_ISAM(&quot;MyISAM&quot;), MEMORY(&quot;MEMORY&quot;), HEAP(&quot;HEAP&quot;), CSV(&quot;CSV&quot;), MERGE(&quot;MERGE&quot;),</span>
<span class="nc" id="L172">            ARCHIVE(&quot;ARCHIVE&quot;), FEDERATED(&quot;FEDERATED&quot;);</span>

            private String s;

<span class="nc" id="L176">            MySQLEngine(String s) {</span>
<span class="nc" id="L177">                this.s = s;</span>
<span class="nc" id="L178">            }</span>

            public static MySQLEngine get(String val) {
<span class="nc" id="L181">                return Stream.of(values()).filter(engine -&gt; engine.s.equalsIgnoreCase(val)).findFirst().get();</span>
            }

        }

        private final MySQLEngine engine;

        public MySQLTable(String tableName, List&lt;MySQLColumn&gt; columns, List&lt;MySQLIndex&gt; indexes, MySQLEngine engine) {
<span class="nc" id="L189">            super(tableName, columns, indexes, false /* TODO: support views */);</span>
<span class="nc" id="L190">            this.engine = engine;</span>
<span class="nc" id="L191">        }</span>

        public MySQLEngine getEngine() {
<span class="nc" id="L194">            return engine;</span>
        }

        public boolean hasPrimaryKey() {
<span class="nc" id="L198">            return getColumns().stream().anyMatch(c -&gt; c.isPrimaryKey());</span>
        }

    }

    public static final class MySQLIndex extends TableIndex {

        private MySQLIndex(String indexName) {
<span class="nc" id="L206">            super(indexName);</span>
<span class="nc" id="L207">        }</span>

        public static MySQLIndex create(String indexName) {
<span class="nc" id="L210">            return new MySQLIndex(indexName);</span>
        }

        @Override
        public String getIndexName() {
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (super.getIndexName().contentEquals(&quot;PRIMARY&quot;)) {</span>
<span class="nc" id="L216">                return &quot;`PRIMARY`&quot;;</span>
            } else {
<span class="nc" id="L218">                return super.getIndexName();</span>
            }
        }

    }

    public static MySQLSchema fromConnection(SQLConnection con, String databaseName) throws SQLException {
<span class="nc" id="L225">        Exception ex = null;</span>
        /* the loop is a workaround for https://bugs.mysql.com/bug.php?id=95929 */
<span class="nc bnc" id="L227" title="All 2 branches missed.">        for (int i = 0; i &lt; NR_SCHEMA_READ_TRIES; i++) {</span>
            try {
<span class="nc" id="L229">                List&lt;MySQLTable&gt; databaseTables = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L230">                try (Statement s = con.createStatement()) {</span>
<span class="nc" id="L231">                    try (ResultSet rs = s.executeQuery(</span>
<span class="nc" id="L232">                            &quot;select TABLE_NAME, ENGINE from information_schema.TABLES where table_schema = '&quot;</span>
<span class="nc" id="L233">                                    + databaseName + &quot;';&quot;)) {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                        while (rs.next()) {</span>
<span class="nc" id="L235">                            String tableName = rs.getString(&quot;TABLE_NAME&quot;);</span>
<span class="nc" id="L236">                            String tableEngineStr = rs.getString(&quot;ENGINE&quot;);</span>
<span class="nc" id="L237">                            MySQLEngine engine = MySQLEngine.get(tableEngineStr);</span>
<span class="nc" id="L238">                            List&lt;MySQLColumn&gt; databaseColumns = getTableColumns(con, tableName, databaseName);</span>
<span class="nc" id="L239">                            List&lt;MySQLIndex&gt; indexes = getIndexes(con, tableName, databaseName);</span>
<span class="nc" id="L240">                            MySQLTable t = new MySQLTable(tableName, databaseColumns, indexes, engine);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">                            for (MySQLColumn c : databaseColumns) {</span>
<span class="nc" id="L242">                                c.setTable(t);</span>
                            }
<span class="nc" id="L244">                            databaseTables.add(t);</span>
                        }
                    }
                }
<span class="nc" id="L248">                return new MySQLSchema(databaseTables);</span>
<span class="nc" id="L249">            } catch (SQLIntegrityConstraintViolationException e) {</span>
<span class="nc" id="L250">                ex = e;</span>
            }
        }
<span class="nc" id="L253">        throw new AssertionError(ex);</span>
    }

    private static List&lt;MySQLIndex&gt; getIndexes(SQLConnection con, String tableName, String databaseName)
            throws SQLException {
<span class="nc" id="L258">        List&lt;MySQLIndex&gt; indexes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L259">        try (Statement s = con.createStatement()) {</span>
<span class="nc" id="L260">            try (ResultSet rs = s.executeQuery(String.format(</span>
<span class="nc" id="L261">                    &quot;SELECT INDEX_NAME FROM INFORMATION_SCHEMA.STATISTICS WHERE TABLE_SCHEMA = '%s' AND TABLE_NAME='%s';&quot;,</span>
<span class="nc" id="L262">                    databaseName, tableName))) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L264">                    String indexName = rs.getString(&quot;INDEX_NAME&quot;);</span>
<span class="nc" id="L265">                    indexes.add(MySQLIndex.create(indexName));</span>
                }
            }
        }
<span class="nc" id="L269">        return indexes;</span>
    }

    private static List&lt;MySQLColumn&gt; getTableColumns(SQLConnection con, String tableName, String databaseName)
            throws SQLException {
<span class="nc" id="L274">        List&lt;MySQLColumn&gt; columns = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L275">        try (Statement s = con.createStatement()) {</span>
<span class="nc" id="L276">            try (ResultSet rs = s.executeQuery(&quot;select * from information_schema.columns where table_schema = '&quot;</span>
<span class="nc" id="L277">                    + databaseName + &quot;' AND TABLE_NAME='&quot; + tableName + &quot;'&quot;)) {</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L279">                    String columnName = rs.getString(&quot;COLUMN_NAME&quot;);</span>
<span class="nc" id="L280">                    String dataType = rs.getString(&quot;DATA_TYPE&quot;);</span>
<span class="nc" id="L281">                    int precision = rs.getInt(&quot;NUMERIC_PRECISION&quot;);</span>
<span class="nc" id="L282">                    boolean isPrimaryKey = rs.getString(&quot;COLUMN_KEY&quot;).equals(&quot;PRI&quot;);</span>
<span class="nc" id="L283">                    MySQLColumn c = new MySQLColumn(columnName, getColumnType(dataType), isPrimaryKey, precision);</span>
<span class="nc" id="L284">                    columns.add(c);</span>
                }
            }
        }
<span class="nc" id="L288">        return columns;</span>
    }

    public MySQLSchema(List&lt;MySQLTable&gt; databaseTables) {
<span class="nc" id="L292">        super(databaseTables);</span>
<span class="nc" id="L293">    }</span>

    public MySQLTables getRandomTableNonEmptyTables() {
<span class="nc" id="L296">        return new MySQLTables(Randomly.nonEmptySubset(getDatabaseTables()));</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>