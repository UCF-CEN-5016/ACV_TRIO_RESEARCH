<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MySQLPivotedQuerySynthesisOracle.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.mysql.oracle</a> &gt; <span class="el_source">MySQLPivotedQuerySynthesisOracle.java</span></div><h1>MySQLPivotedQuerySynthesisOracle.java</h1><pre class="source lang-java linenums">package dqetool.mysql.oracle;

import java.sql.SQLException;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

import dqetool.Randomly;
import dqetool.SQLConnection;
import dqetool.common.oracle.PivotedQuerySynthesisBase;
import dqetool.common.query.Query;
import dqetool.common.query.SQLQueryAdapter;
import dqetool.mysql.MySQLErrors;
import dqetool.mysql.MySQLGlobalState;
import dqetool.mysql.MySQLSchema.MySQLColumn;
import dqetool.mysql.MySQLSchema.MySQLRowValue;
import dqetool.mysql.MySQLSchema.MySQLTable;
import dqetool.mysql.MySQLSchema.MySQLTables;
import dqetool.mysql.MySQLVisitor;
import dqetool.mysql.ast.MySQLColumnReference;
import dqetool.mysql.ast.MySQLConstant;
import dqetool.mysql.ast.MySQLExpression;
import dqetool.mysql.ast.MySQLSelect;
import dqetool.mysql.ast.MySQLTableReference;
import dqetool.mysql.ast.MySQLUnaryPostfixOperation;
import dqetool.mysql.ast.MySQLUnaryPostfixOperation.UnaryPostfixOperator;
import dqetool.mysql.ast.MySQLUnaryPrefixOperation;
import dqetool.mysql.ast.MySQLUnaryPrefixOperation.MySQLUnaryPrefixOperator;
import dqetool.mysql.gen.MySQLExpressionGenerator;

public class MySQLPivotedQuerySynthesisOracle
        extends PivotedQuerySynthesisBase&lt;MySQLGlobalState, MySQLRowValue, MySQLExpression, SQLConnection&gt; {

    private List&lt;MySQLExpression&gt; fetchColumns;
    private List&lt;MySQLColumn&gt; columns;

    public MySQLPivotedQuerySynthesisOracle(MySQLGlobalState globalState) throws SQLException {
<span class="nc" id="L38">        super(globalState);</span>
<span class="nc" id="L39">        MySQLErrors.addExpressionErrors(errors);</span>
<span class="nc" id="L40">        errors.add(&quot;in 'order clause'&quot;); // e.g., Unknown column '2067708013' in 'order clause'</span>
<span class="nc" id="L41">    }</span>

    @Override
    public Query&lt;SQLConnection&gt; getRectifiedQuery() throws SQLException {
<span class="nc" id="L45">        MySQLTables randomFromTables = globalState.getSchema().getRandomTableNonEmptyTables();</span>
<span class="nc" id="L46">        List&lt;MySQLTable&gt; tables = randomFromTables.getTables();</span>

<span class="nc" id="L48">        MySQLSelect selectStatement = new MySQLSelect();</span>
<span class="nc" id="L49">        selectStatement.setSelectType(Randomly.fromOptions(MySQLSelect.SelectType.values()));</span>
<span class="nc" id="L50">        columns = randomFromTables.getColumns();</span>
<span class="nc" id="L51">        pivotRow = randomFromTables.getRandomRowValue(globalState.getConnection());</span>

<span class="nc" id="L53">        selectStatement.setFromList(tables.stream().map(t -&gt; new MySQLTableReference(t)).collect(Collectors.toList()));</span>

<span class="nc" id="L55">        fetchColumns = columns.stream().map(c -&gt; new MySQLColumnReference(c, null)).collect(Collectors.toList());</span>
<span class="nc" id="L56">        selectStatement.setFetchColumns(fetchColumns);</span>
<span class="nc" id="L57">        MySQLExpression whereClause = generateRectifiedExpression(columns, pivotRow);</span>
<span class="nc" id="L58">        selectStatement.setWhereClause(whereClause);</span>
<span class="nc" id="L59">        List&lt;MySQLExpression&gt; groupByClause = generateGroupByClause(columns, pivotRow);</span>
<span class="nc" id="L60">        selectStatement.setGroupByExpressions(groupByClause);</span>
<span class="nc" id="L61">        MySQLExpression limitClause = generateLimit();</span>
<span class="nc" id="L62">        selectStatement.setLimitClause(limitClause);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (limitClause != null) {</span>
<span class="nc" id="L64">            MySQLExpression offsetClause = generateOffset();</span>
<span class="nc" id="L65">            selectStatement.setOffsetClause(offsetClause);</span>
        }
<span class="nc" id="L67">        List&lt;String&gt; modifiers = Randomly.subset(&quot;STRAIGHT_JOIN&quot;, &quot;SQL_SMALL_RESULT&quot;, &quot;SQL_BIG_RESULT&quot;, &quot;SQL_NO_CACHE&quot;);</span>
<span class="nc" id="L68">        selectStatement.setModifiers(modifiers);</span>
<span class="nc" id="L69">        List&lt;MySQLExpression&gt; orderBy = new MySQLExpressionGenerator(globalState).setColumns(columns)</span>
<span class="nc" id="L70">                .generateOrderBys();</span>
<span class="nc" id="L71">        selectStatement.setOrderByExpressions(orderBy);</span>

<span class="nc" id="L73">        return new SQLQueryAdapter(MySQLVisitor.asString(selectStatement), errors);</span>
    }

    private List&lt;MySQLExpression&gt; generateGroupByClause(List&lt;MySQLColumn&gt; columns, MySQLRowValue rw) {
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (Randomly.getBoolean()) {</span>
<span class="nc" id="L78">            return columns.stream().map(c -&gt; MySQLColumnReference.create(c, rw.getValues().get(c)))</span>
<span class="nc" id="L79">                    .collect(Collectors.toList());</span>
        } else {
<span class="nc" id="L81">            return Collections.emptyList();</span>
        }
    }

    private MySQLConstant generateLimit() {
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (Randomly.getBoolean()) {</span>
<span class="nc" id="L87">            return MySQLConstant.createIntConstant(Integer.MAX_VALUE);</span>
        } else {
<span class="nc" id="L89">            return null;</span>
        }
    }

    private MySQLExpression generateOffset() {
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (Randomly.getBoolean()) {</span>
<span class="nc" id="L95">            return MySQLConstant.createIntConstantNotAsBoolean(0);</span>
        } else {
<span class="nc" id="L97">            return null;</span>
        }
    }

    private MySQLExpression generateRectifiedExpression(List&lt;MySQLColumn&gt; columns, MySQLRowValue rw) {
<span class="nc" id="L102">        MySQLExpression expression = new MySQLExpressionGenerator(globalState).setRowVal(rw).setColumns(columns)</span>
<span class="nc" id="L103">                .generateExpression();</span>
<span class="nc" id="L104">        MySQLConstant expectedValue = expression.getExpectedValue();</span>
        MySQLExpression result;
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (expectedValue.isNull()) {</span>
<span class="nc" id="L107">            result = new MySQLUnaryPostfixOperation(expression, UnaryPostfixOperator.IS_NULL, false);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        } else if (expectedValue.asBooleanNotNull()) {</span>
<span class="nc" id="L109">            result = expression;</span>
<span class="nc" id="L110">        } else {</span>
<span class="nc" id="L111">            result = new MySQLUnaryPrefixOperation(expression, MySQLUnaryPrefixOperator.NOT);</span>
        }
<span class="nc" id="L113">        rectifiedPredicates.add(result);</span>
<span class="nc" id="L114">        return result;</span>
    }

    @Override
    protected Query&lt;SQLConnection&gt; getContainmentCheckQuery(Query&lt;?&gt; query) throws SQLException {
<span class="nc" id="L119">        StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L120">        sb.append(&quot;SELECT * FROM (&quot;); // ANOTHER SELECT TO USE ORDER BY without restrictions</span>
<span class="nc" id="L121">        sb.append(query.getUnterminatedQueryString());</span>
<span class="nc" id="L122">        sb.append(&quot;) as result WHERE &quot;);</span>
<span class="nc" id="L123">        int i = 0;</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        for (MySQLColumn c : columns) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            if (i++ != 0) {</span>
<span class="nc" id="L126">                sb.append(&quot; AND &quot;);</span>
            }
<span class="nc" id="L128">            sb.append(&quot;result.&quot;);</span>
<span class="nc" id="L129">            sb.append(&quot;ref&quot;);</span>
<span class="nc" id="L130">            sb.append(i - 1);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            if (pivotRow.getValues().get(c).isNull()) {</span>
<span class="nc" id="L132">                sb.append(&quot; IS NULL&quot;);</span>
<span class="nc" id="L133">            } else {</span>
<span class="nc" id="L134">                sb.append(&quot; = &quot;);</span>
<span class="nc" id="L135">                sb.append(pivotRow.getValues().get(c).getTextRepresentation());</span>
            }
        }

<span class="nc" id="L139">        String resultingQueryString = sb.toString();</span>
<span class="nc" id="L140">        return new SQLQueryAdapter(resultingQueryString, query.getExpectedErrors());</span>
    }

    @Override
    protected String getExpectedValues(MySQLExpression expr) {
<span class="nc" id="L145">        return MySQLVisitor.asExpectedValues(expr);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>