<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CockroachDBExpressionGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.cockroachdb.gen</a> &gt; <span class="el_source">CockroachDBExpressionGenerator.java</span></div><h1>CockroachDBExpressionGenerator.java</h1><pre class="source lang-java linenums">package dqetool.cockroachdb.gen;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

import dqetool.Randomly;
import dqetool.cockroachdb.CockroachDBCommon;
import dqetool.cockroachdb.CockroachDBProvider.CockroachDBGlobalState;
import dqetool.cockroachdb.CockroachDBSchema.CockroachDBColumn;
import dqetool.cockroachdb.CockroachDBSchema.CockroachDBCompositeDataType;
import dqetool.cockroachdb.CockroachDBSchema.CockroachDBDataType;
import dqetool.cockroachdb.ast.CockroachDBAggregate;
import dqetool.cockroachdb.ast.CockroachDBAggregate.CockroachDBAggregateFunction;
import dqetool.cockroachdb.ast.CockroachDBBetweenOperation;
import dqetool.cockroachdb.ast.CockroachDBBetweenOperation.CockroachDBBetweenOperatorType;
import dqetool.cockroachdb.ast.CockroachDBBinaryArithmeticOperation;
import dqetool.cockroachdb.ast.CockroachDBBinaryArithmeticOperation.CockroachDBBinaryArithmeticOperator;
import dqetool.cockroachdb.ast.CockroachDBBinaryComparisonOperator;
import dqetool.cockroachdb.ast.CockroachDBBinaryComparisonOperator.CockroachDBComparisonOperator;
import dqetool.cockroachdb.ast.CockroachDBBinaryLogicalOperation;
import dqetool.cockroachdb.ast.CockroachDBBinaryLogicalOperation.CockroachDBBinaryLogicalOperator;
import dqetool.cockroachdb.ast.CockroachDBCaseOperation;
import dqetool.cockroachdb.ast.CockroachDBCast;
import dqetool.cockroachdb.ast.CockroachDBCollate;
import dqetool.cockroachdb.ast.CockroachDBColumnReference;
import dqetool.cockroachdb.ast.CockroachDBConcatOperation;
import dqetool.cockroachdb.ast.CockroachDBConstant;
import dqetool.cockroachdb.ast.CockroachDBExpression;
import dqetool.cockroachdb.ast.CockroachDBFunction;
import dqetool.cockroachdb.ast.CockroachDBInOperation;
import dqetool.cockroachdb.ast.CockroachDBMultiValuedComparison;
import dqetool.cockroachdb.ast.CockroachDBMultiValuedComparison.MultiValuedComparisonOperator;
import dqetool.cockroachdb.ast.CockroachDBMultiValuedComparison.MultiValuedComparisonType;
import dqetool.cockroachdb.ast.CockroachDBNotOperation;
import dqetool.cockroachdb.ast.CockroachDBOrderingTerm;
import dqetool.cockroachdb.ast.CockroachDBRegexOperation;
import dqetool.cockroachdb.ast.CockroachDBRegexOperation.CockroachDBRegexOperator;
import dqetool.cockroachdb.ast.CockroachDBTypeAnnotation;
import dqetool.cockroachdb.ast.CockroachDBUnaryPostfixOperation;
import dqetool.cockroachdb.ast.CockroachDBUnaryPostfixOperation.CockroachDBUnaryPostfixOperator;
import dqetool.common.gen.TypedExpressionGenerator;

public class CockroachDBExpressionGenerator
        extends TypedExpressionGenerator&lt;CockroachDBExpression, CockroachDBColumn, CockroachDBCompositeDataType&gt; {

    private final CockroachDBGlobalState globalState;

<span class="nc" id="L49">    public CockroachDBExpressionGenerator(CockroachDBGlobalState globalState) {</span>
<span class="nc" id="L50">        this.globalState = globalState;</span>
<span class="nc" id="L51">    }</span>

    @Override
    public CockroachDBExpression generateExpression(CockroachDBCompositeDataType dataType) {
<span class="nc" id="L55">        return generateExpression(dataType, 0);</span>
    }

    public CockroachDBExpression generateAggregate() {
<span class="nc" id="L59">        return getAggregate(getRandomType());</span>
    }

    public CockroachDBExpression generateHavingClause() {
<span class="nc" id="L63">        allowAggregates = true;</span>
<span class="nc" id="L64">        CockroachDBExpression expression = generateExpression(CockroachDBDataType.BOOL.get());</span>
<span class="nc" id="L65">        allowAggregates = false;</span>
<span class="nc" id="L66">        return expression;</span>
    }

    public List&lt;CockroachDBExpression&gt; getOrderingTerms() {
<span class="nc" id="L70">        List&lt;CockroachDBExpression&gt; orderingTerms = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L71">        int nr = 1;</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        while (Randomly.getBooleanWithSmallProbability()) {</span>
<span class="nc" id="L73">            nr++;</span>
        }
<span class="nc bnc" id="L75" title="All 2 branches missed.">        for (int i = 0; i &lt; nr; i++) {</span>
<span class="nc" id="L76">            CockroachDBExpression expr = generateExpression(getRandomType());</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">            if (Randomly.getBoolean()) {</span>
<span class="nc" id="L78">                expr = new CockroachDBOrderingTerm(expr, Randomly.getBoolean());</span>
            }
<span class="nc" id="L80">            orderingTerms.add(expr);</span>
        }
<span class="nc" id="L82">        return orderingTerms;</span>
    }

    @Override
    public CockroachDBExpression generateExpression(CockroachDBCompositeDataType type, int depth) {
        // if (type == CockroachDBDataType.FLOAT &amp;&amp; Randomly.getBooleanWithRatherLowProbability()) {
        // type = CockroachDBDataType.INT;
        // }
<span class="nc bnc" id="L90" title="All 4 branches missed.">        if (allowAggregates &amp;&amp; Randomly.getBoolean()) {</span>
<span class="nc" id="L91">            return getAggregate(type);</span>
        }
<span class="nc bnc" id="L93" title="All 4 branches missed.">        if (depth &gt;= globalState.getOptions().getMaxExpressionDepth() || Randomly.getBoolean()) {</span>
<span class="nc" id="L94">            return generateLeafNode(type);</span>
        } else {
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (Randomly.getBooleanWithRatherLowProbability()) {</span>
<span class="nc" id="L97">                List&lt;CockroachDBFunction&gt; applicableFunctions = CockroachDBFunction.getFunctionsCompatibleWith(type);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (!applicableFunctions.isEmpty()) {</span>
<span class="nc" id="L99">                    CockroachDBFunction function = Randomly.fromList(applicableFunctions);</span>
<span class="nc" id="L100">                    return function.getCall(type, this, depth + 1);</span>
                }
            }
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (Randomly.getBooleanWithRatherLowProbability()) {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                if (Randomly.getBoolean()) {</span>
<span class="nc" id="L105">                    return new CockroachDBCast(generateExpression(getRandomType(), depth + 1), type);</span>
                } else {
<span class="nc" id="L107">                    return new CockroachDBTypeAnnotation(generateExpression(type, depth + 1), type);</span>
                }
            }
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (Randomly.getBooleanWithRatherLowProbability()) {</span>
<span class="nc" id="L111">                List&lt;CockroachDBExpression&gt; conditions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L112">                List&lt;CockroachDBExpression&gt; cases = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                for (int i = 0; i &lt; Randomly.smallNumber() + 1; i++) {</span>
<span class="nc" id="L114">                    conditions.add(generateExpression(CockroachDBDataType.BOOL.get(), depth + 1));</span>
<span class="nc" id="L115">                    cases.add(generateExpression(type, depth + 1));</span>
                }
<span class="nc" id="L117">                CockroachDBExpression elseExpr = null;</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                if (Randomly.getBoolean()) {</span>
<span class="nc" id="L119">                    elseExpr = generateExpression(type, depth + 1);</span>
                }
<span class="nc" id="L121">                return new CockroachDBCaseOperation(conditions, cases, elseExpr);</span>

            }

<span class="nc bnc" id="L125" title="All 5 branches missed.">            switch (type.getPrimitiveDataType()) {</span>
            case BOOL:
<span class="nc" id="L127">                return generateBooleanExpression(depth);</span>
            case INT:
            case SERIAL:
<span class="nc" id="L130">                return new CockroachDBBinaryArithmeticOperation(</span>
<span class="nc" id="L131">                        generateExpression(CockroachDBDataType.INT.get(), depth + 1),</span>
<span class="nc" id="L132">                        generateExpression(CockroachDBDataType.INT.get(), depth + 1),</span>
<span class="nc" id="L133">                        CockroachDBBinaryArithmeticOperator.getRandom());</span>
            case STRING:
            case BYTES: // TODO split
<span class="nc" id="L136">                CockroachDBExpression stringExpr = generateStringExpression(depth);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                if (Randomly.getBoolean()) {</span>
<span class="nc" id="L138">                    stringExpr = new CockroachDBCollate(stringExpr, CockroachDBCommon.getRandomCollate());</span>
                }
<span class="nc" id="L140">                return stringExpr; // TODO</span>
            case FLOAT:
            case VARBIT:
            case BIT:
            case INTERVAL:
            case TIMESTAMP:
            case DECIMAL:
            case TIMESTAMPTZ:
            case JSONB:
            case TIME:
            case TIMETZ:
            case ARRAY:
<span class="nc" id="L152">                return generateLeafNode(type); // TODO</span>
            default:
<span class="nc" id="L154">                throw new AssertionError(type);</span>
            }
        }
    }

    private CockroachDBExpression getAggregate(CockroachDBCompositeDataType type) {
<span class="nc" id="L160">        CockroachDBAggregateFunction agg = Randomly</span>
<span class="nc" id="L161">                .fromList(CockroachDBAggregate.CockroachDBAggregateFunction.getAggregates(type.getPrimitiveDataType()));</span>
<span class="nc" id="L162">        return generateArgsForAggregate(type, agg);</span>
    }

    public CockroachDBAggregate generateArgsForAggregate(CockroachDBCompositeDataType type,
            CockroachDBAggregateFunction agg) {
<span class="nc" id="L167">        List&lt;CockroachDBDataType&gt; types = agg.getTypes(type.getPrimitiveDataType());</span>
<span class="nc" id="L168">        List&lt;CockroachDBExpression&gt; args = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L169">        allowAggregates = false; //</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        for (CockroachDBDataType argType : types) {</span>
<span class="nc" id="L171">            args.add(generateExpression(argType.get()));</span>
        }
<span class="nc" id="L173">        return new CockroachDBAggregate(agg, args);</span>
    }

<span class="nc" id="L176">    private enum BooleanExpression {</span>
<span class="nc" id="L177">        NOT, COMPARISON, AND_OR_CHAIN, REGEX, IS_NULL, IS_NAN, IN, BETWEEN, MULTI_VALUED_COMPARISON</span>
    }

<span class="nc" id="L180">    private enum StringExpression {</span>
<span class="nc" id="L181">        CONCAT</span>
    }

    private CockroachDBExpression generateStringExpression(int depth) {
<span class="nc" id="L185">        StringExpression exprType = Randomly.fromOptions(StringExpression.values());</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">        switch (exprType) {</span>
        case CONCAT:
<span class="nc" id="L188">            return new CockroachDBConcatOperation(generateExpression(CockroachDBDataType.STRING.get(), depth + 1),</span>
<span class="nc" id="L189">                    generateExpression(CockroachDBDataType.STRING.get(), depth + 1));</span>
        default:
<span class="nc" id="L191">            throw new AssertionError(exprType);</span>
        }
    }

    private CockroachDBExpression generateBooleanExpression(int depth) {
<span class="nc" id="L196">        BooleanExpression exprType = Randomly.fromOptions(BooleanExpression.values());</span>
        CockroachDBExpression expr;
<span class="nc bnc" id="L198" title="All 10 branches missed.">        switch (exprType) {</span>
        case NOT:
<span class="nc" id="L200">            return new CockroachDBNotOperation(generateExpression(CockroachDBDataType.BOOL.get(), depth + 1));</span>
        case COMPARISON:
<span class="nc" id="L202">            return getBinaryComparison(depth);</span>
        case AND_OR_CHAIN:
<span class="nc" id="L204">            return getAndOrChain(depth);</span>
        case REGEX:
<span class="nc" id="L206">            return new CockroachDBRegexOperation(generateExpression(CockroachDBDataType.STRING.get(), depth + 1),</span>
<span class="nc" id="L207">                    generateExpression(CockroachDBDataType.STRING.get(), depth + 1),</span>
<span class="nc" id="L208">                    CockroachDBRegexOperator.getRandom());</span>
        case IS_NULL:
<span class="nc" id="L210">            return new CockroachDBUnaryPostfixOperation(generateExpression(getRandomType(), depth + 1), Randomly</span>
<span class="nc" id="L211">                    .fromOptions(CockroachDBUnaryPostfixOperator.IS_NULL, CockroachDBUnaryPostfixOperator.IS_NOT_NULL));</span>
        case IS_NAN:
<span class="nc" id="L213">            return new CockroachDBUnaryPostfixOperation(generateExpression(CockroachDBDataType.FLOAT.get(), depth + 1),</span>
<span class="nc" id="L214">                    Randomly.fromOptions(CockroachDBUnaryPostfixOperator.IS_NAN,</span>
<span class="nc" id="L215">                            CockroachDBUnaryPostfixOperator.IS_NOT_NAN));</span>
        case IN:
<span class="nc" id="L217">            return getInOperation(depth);</span>
        case BETWEEN:
<span class="nc" id="L219">            CockroachDBCompositeDataType type = getRandomType();</span>
<span class="nc" id="L220">            expr = generateExpression(type, depth + 1);</span>
<span class="nc" id="L221">            CockroachDBExpression left = generateExpression(type, depth + 1);</span>
<span class="nc" id="L222">            CockroachDBExpression right = generateExpression(type, depth + 1);</span>
<span class="nc" id="L223">            return new CockroachDBBetweenOperation(expr, left, right, CockroachDBBetweenOperatorType.getRandom());</span>
        case MULTI_VALUED_COMPARISON: // TODO other operators
<span class="nc" id="L225">            type = getRandomType();</span>
<span class="nc" id="L226">            left = generateExpression(type, depth + 1);</span>
<span class="nc" id="L227">            List&lt;CockroachDBExpression&gt; rightList = generateExpressions(type, Randomly.smallNumber() + 2, depth + 1);</span>
<span class="nc" id="L228">            return new CockroachDBMultiValuedComparison(left, rightList, MultiValuedComparisonType.getRandom(),</span>
<span class="nc" id="L229">                    MultiValuedComparisonOperator.getRandomGenericComparisonOperator());</span>
        default:
<span class="nc" id="L231">            throw new AssertionError(exprType);</span>
        }
    }

    private CockroachDBExpression getAndOrChain(int depth) {
<span class="nc" id="L236">        CockroachDBExpression left = generateExpression(CockroachDBDataType.BOOL.get(), depth + 1);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">        for (int i = 0; i &lt; Randomly.smallNumber() + 1; i++) {</span>
<span class="nc" id="L238">            CockroachDBExpression right = generateExpression(CockroachDBDataType.BOOL.get(), depth + 1);</span>
<span class="nc" id="L239">            left = new CockroachDBBinaryLogicalOperation(left, right, CockroachDBBinaryLogicalOperator.getRandom());</span>
        }
<span class="nc" id="L241">        return left;</span>
    }

    private CockroachDBExpression getInOperation(int depth) {
<span class="nc" id="L245">        CockroachDBCompositeDataType type = getRandomType();</span>
<span class="nc" id="L246">        return new CockroachDBInOperation(generateExpression(type, depth + 1),</span>
<span class="nc" id="L247">                generateExpressions(type, Randomly.smallNumber() + 1, depth + 1));</span>
    }

    @Override
    protected CockroachDBCompositeDataType getRandomType() {
<span class="nc bnc" id="L252" title="All 4 branches missed.">        if (columns.isEmpty() || Randomly.getBooleanWithRatherLowProbability()) {</span>
<span class="nc" id="L253">            return CockroachDBCompositeDataType.getRandom();</span>
        } else {
<span class="nc" id="L255">            return Randomly.fromList(columns).getType();</span>
        }
    }

    private CockroachDBExpression getBinaryComparison(int depth) {
<span class="nc" id="L260">        CockroachDBCompositeDataType type = getRandomType();</span>
<span class="nc" id="L261">        CockroachDBExpression left = generateExpression(type, depth + 1);</span>
<span class="nc" id="L262">        CockroachDBExpression right = generateExpression(type, depth + 1);</span>
<span class="nc" id="L263">        return new CockroachDBBinaryComparisonOperator(left, right, CockroachDBComparisonOperator.getRandom());</span>
    }

    @Override
    protected boolean canGenerateColumnOfType(CockroachDBCompositeDataType type) {
<span class="nc bnc" id="L268" title="All 2 branches missed.">        return columns.stream().anyMatch(c -&gt; c.getType() == type);</span>
    }

    @Override
    public CockroachDBExpression generateConstant(CockroachDBCompositeDataType type) {
<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (Randomly.getBooleanWithRatherLowProbability()) {</span>
<span class="nc" id="L274">            return CockroachDBConstant.createNullConstant();</span>
        }
<span class="nc bnc" id="L276" title="All 14 branches missed.">        switch (type.getPrimitiveDataType()) {</span>
        case INT:
        case SERIAL:
        case DECIMAL: // TODO: generate random decimals
<span class="nc" id="L280">            return CockroachDBConstant.createIntConstant(globalState.getRandomly().getInteger());</span>
        case BOOL:
<span class="nc" id="L282">            return CockroachDBConstant.createBooleanConstant(Randomly.getBoolean());</span>
        case STRING:
        case BYTES: // TODO: also generate byte constants
<span class="nc" id="L285">            return getStringConstant();</span>
        case FLOAT:
<span class="nc" id="L287">            return CockroachDBConstant.createFloatConstant(globalState.getRandomly().getDouble());</span>
        case BIT:
<span class="nc" id="L289">            return CockroachDBConstant.createBitConstantWithSize(type.getSize());</span>
        case VARBIT:
<span class="nc bnc" id="L291" title="All 2 branches missed.">            if (Randomly.getBoolean()) {</span>
<span class="nc" id="L292">                return CockroachDBConstant.createBitConstant(globalState.getRandomly().getInteger());</span>
            } else {
<span class="nc" id="L294">                return CockroachDBConstant.createBitConstantWithSize((int) Randomly.getNotCachedInteger(1, 10));</span>
            }
        case INTERVAL:
<span class="nc" id="L297">            return CockroachDBConstant.createIntervalConstant(globalState.getRandomly().getInteger(),</span>
<span class="nc" id="L298">                    globalState.getRandomly().getInteger(), globalState.getRandomly().getInteger(),</span>
<span class="nc" id="L299">                    globalState.getRandomly().getInteger(), globalState.getRandomly().getInteger(),</span>
<span class="nc" id="L300">                    globalState.getRandomly().getInteger());</span>
        case TIMESTAMP:
<span class="nc" id="L302">            return CockroachDBConstant.createTimestampConstant(globalState.getRandomly().getInteger());</span>
        case TIMESTAMPTZ:
<span class="nc" id="L304">            return CockroachDBConstant.createTimestamptzConstant(globalState.getRandomly().getInteger());</span>
        case TIME:
<span class="nc" id="L306">            return CockroachDBConstant.createTimeConstant(globalState.getRandomly().getInteger());</span>
        case TIMETZ:
<span class="nc" id="L308">            return CockroachDBConstant.createTimetz(globalState.getRandomly().getInteger());</span>
        case ARRAY:
<span class="nc" id="L310">            List&lt;CockroachDBExpression&gt; elements = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">            for (int i = 0; i &lt; Randomly.smallNumber(); i++) {</span>
<span class="nc" id="L312">                elements.add(generateConstant(type.getElementType()));</span>
            }
<span class="nc" id="L314">            return CockroachDBConstant.createArrayConstant(elements);</span>
        case JSONB:
<span class="nc" id="L316">            return CockroachDBConstant.createNullConstant(); // TODO</span>
        default:
<span class="nc" id="L318">            throw new AssertionError(type);</span>
        }
    }

    private CockroachDBExpression getStringConstant() {
<span class="nc" id="L323">        CockroachDBExpression strConst = CockroachDBConstant</span>
<span class="nc" id="L324">                .createStringConstant(globalState.getRandomly().getString());</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (Randomly.getBooleanWithRatherLowProbability()) {</span>
<span class="nc" id="L326">            strConst = new CockroachDBCollate(strConst, CockroachDBCommon.getRandomCollate());</span>
        }
<span class="nc" id="L328">        return strConst;</span>
    }

    public CockroachDBGlobalState getGlobalState() {
<span class="nc" id="L332">        return globalState;</span>
    }

    @Override
    protected CockroachDBExpression generateColumn(CockroachDBCompositeDataType type) {
<span class="nc" id="L337">        CockroachDBColumn column = Randomly</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                .fromList(columns.stream().filter(c -&gt; c.getType() == type).collect(Collectors.toList()));</span>
<span class="nc" id="L339">        CockroachDBExpression columnReference = new CockroachDBColumnReference(column);</span>
<span class="nc bnc" id="L340" title="All 4 branches missed.">        if (column.getType().isString() &amp;&amp; Randomly.getBooleanWithRatherLowProbability()) {</span>
<span class="nc" id="L341">            columnReference = new CockroachDBCollate(columnReference, CockroachDBCommon.getRandomCollate());</span>
        }
<span class="nc" id="L343">        return columnReference;</span>
    }

    @Override
    public CockroachDBExpression generatePredicate() {
<span class="nc" id="L348">        return generateExpression(CockroachDBDataType.BOOL.get());</span>
    }

    @Override
    public CockroachDBExpression negatePredicate(CockroachDBExpression predicate) {
<span class="nc" id="L353">        return new CockroachDBNotOperation(predicate);</span>
    }

    @Override
    public CockroachDBExpression isNull(CockroachDBExpression expr) {
<span class="nc" id="L358">        return new CockroachDBUnaryPostfixOperation(expr, CockroachDBUnaryPostfixOperator.IS_NULL);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>