<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MySQLConstant.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.mysql.ast</a> &gt; <span class="el_source">MySQLConstant.java</span></div><h1>MySQLConstant.java</h1><pre class="source lang-java linenums">package dqetool.mysql.ast;

import java.math.BigInteger;

import dqetool.IgnoreMeException;
import dqetool.Randomly;
import dqetool.mysql.MySQLSchema.MySQLDataType;
import dqetool.mysql.ast.MySQLCastOperation.CastType;

<span class="nc" id="L10">public abstract class MySQLConstant implements MySQLExpression {</span>

    public boolean isInt() {
<span class="nc" id="L13">        return false;</span>
    }

    public boolean isNull() {
<span class="nc" id="L17">        return false;</span>
    }

<span class="nc" id="L20">    public abstract static class MySQLNoPQSConstant extends MySQLConstant {</span>

        @Override
        public boolean asBooleanNotNull() {
<span class="nc" id="L24">            throw throwException();</span>
        }

        private RuntimeException throwException() {
<span class="nc" id="L28">            throw new UnsupportedOperationException(&quot;not applicable for PQS evaluation!&quot;);</span>
        }

        @Override
        public MySQLConstant isEquals(MySQLConstant rightVal) {
<span class="nc" id="L33">            return null;</span>
        }

        @Override
        public MySQLConstant castAs(CastType type) {
<span class="nc" id="L38">            throw throwException();</span>
        }

        @Override
        public String castAsString() {
<span class="nc" id="L43">            throw throwException();</span>

        }

        @Override
        public MySQLDataType getType() {
<span class="nc" id="L49">            throw throwException();</span>
        }

        @Override
        protected MySQLConstant isLessThan(MySQLConstant rightVal) {
<span class="nc" id="L54">            throw throwException();</span>
        }

    }

    public static class MySQLDoubleConstant extends MySQLNoPQSConstant {

        private final double val;

<span class="nc" id="L63">        public MySQLDoubleConstant(double val) {</span>
<span class="nc" id="L64">            this.val = val;</span>
<span class="nc bnc" id="L65" title="All 4 branches missed.">            if (Double.isInfinite(val) || Double.isNaN(val)) {</span>
                // seems to not be supported by MySQL
<span class="nc" id="L67">                throw new IgnoreMeException();</span>
            }
<span class="nc" id="L69">        }</span>

        @Override
        public String getTextRepresentation() {
<span class="nc" id="L73">            return String.valueOf(val);</span>
        }

    }

    public static class MySQLTextConstant extends MySQLConstant {

        private final String value;
        private final boolean singleQuotes;

<span class="nc" id="L83">        public MySQLTextConstant(String value) {</span>
<span class="nc" id="L84">            this.value = value;</span>
<span class="nc" id="L85">            singleQuotes = Randomly.getBoolean();</span>

<span class="nc" id="L87">        }</span>

        private void checkIfSmallFloatingPointText() {
<span class="nc bnc" id="L90" title="All 4 branches missed.">            boolean isSmallFloatingPointText = isString() &amp;&amp; asBooleanNotNull()</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">                    &amp;&amp; castAs(CastType.SIGNED).getInt() == 0;</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            if (isSmallFloatingPointText) {</span>
<span class="nc" id="L93">                throw new IgnoreMeException();</span>
            }
<span class="nc" id="L95">        }</span>

        @Override
        public boolean asBooleanNotNull() {
            // TODO implement as cast
<span class="nc bnc" id="L100" title="All 2 branches missed.">            for (int i = value.length(); i &gt;= 0; i--) {</span>
                try {
<span class="nc" id="L102">                    String substring = value.substring(0, i);</span>
<span class="nc" id="L103">                    Double val = Double.valueOf(substring);</span>
<span class="nc bnc" id="L104" title="All 4 branches missed.">                    return val != 0 &amp;&amp; !Double.isNaN(val);</span>
<span class="nc" id="L105">                } catch (NumberFormatException e) {</span>
                    // ignore
                }
            }
<span class="nc" id="L109">            return false;</span>
            // return castAs(CastType.SIGNED).getInt() != 0;
        }

        @Override
        public String getTextRepresentation() {
<span class="nc" id="L115">            StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">            String quotes = singleQuotes ? &quot;'&quot; : &quot;\&quot;&quot;;</span>
<span class="nc" id="L117">            sb.append(quotes);</span>
<span class="nc" id="L118">            String text = value.replace(quotes, quotes + quotes).replace(&quot;\\&quot;, &quot;\\\\&quot;);</span>
<span class="nc" id="L119">            sb.append(text);</span>
<span class="nc" id="L120">            sb.append(quotes);</span>
<span class="nc" id="L121">            return sb.toString();</span>
        }

        @Override
        public MySQLConstant isEquals(MySQLConstant rightVal) {
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (rightVal.isNull()) {</span>
<span class="nc" id="L127">                return MySQLConstant.createNullConstant();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            } else if (rightVal.isInt()) {</span>
<span class="nc" id="L129">                checkIfSmallFloatingPointText();</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                if (asBooleanNotNull()) {</span>
                    // TODO support SELECT .123 = '.123'; by converting to floating point
<span class="nc" id="L132">                    throw new IgnoreMeException();</span>
                }
<span class="nc" id="L134">                return castAs(CastType.SIGNED).isEquals(rightVal);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            } else if (rightVal.isString()) {</span>
<span class="nc" id="L136">                return MySQLConstant.createBoolean(value.equalsIgnoreCase(rightVal.getString()));</span>
            } else {
<span class="nc" id="L138">                throw new AssertionError(rightVal);</span>
            }
        }

        @Override
        public String getString() {
<span class="nc" id="L144">            return value;</span>
        }

        @Override
        public boolean isString() {
<span class="nc" id="L149">            return true;</span>
        }

        @Override
        public MySQLConstant castAs(CastType type) {
<span class="nc bnc" id="L154" title="All 4 branches missed.">            if (type == CastType.SIGNED || type == CastType.UNSIGNED) {</span>
<span class="nc" id="L155">                String value = this.value;</span>
<span class="nc bnc" id="L156" title="All 6 branches missed.">                while (value.startsWith(&quot; &quot;) || value.startsWith(&quot;\t&quot;) || value.startsWith(&quot;\n&quot;)) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                    if (value.startsWith(&quot;\n&quot;)) {</span>
                        /* workaround for https://bugs.mysql.com/bug.php?id=96294 */
<span class="nc" id="L159">                        throw new IgnoreMeException();</span>
                    }
<span class="nc" id="L161">                    value = value.substring(1);</span>
                }
<span class="nc bnc" id="L163" title="All 2 branches missed.">                for (int i = value.length(); i &gt;= 0; i--) {</span>
                    try {
<span class="nc" id="L165">                        String substring = value.substring(0, i);</span>
<span class="nc" id="L166">                        long val = Long.parseLong(substring);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                        return MySQLConstant.createIntConstant(val, type == CastType.SIGNED);</span>
<span class="nc" id="L168">                    } catch (NumberFormatException e) {</span>
                        // ignore
                    }
                }
<span class="nc bnc" id="L172" title="All 2 branches missed.">                return MySQLConstant.createIntConstant(0, type == CastType.SIGNED);</span>
            } else {
<span class="nc" id="L174">                throw new AssertionError();</span>
            }
        }

        @Override
        public String castAsString() {
<span class="nc" id="L180">            return value;</span>
        }

        @Override
        public MySQLDataType getType() {
<span class="nc" id="L185">            return MySQLDataType.VARCHAR;</span>
        }

        @Override
        protected MySQLConstant isLessThan(MySQLConstant rightVal) {
<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (rightVal.isNull()) {</span>
<span class="nc" id="L191">                return MySQLConstant.createNullConstant();</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">            } else if (rightVal.isInt()) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                if (asBooleanNotNull()) {</span>
                    // TODO uspport floating point
<span class="nc" id="L195">                    throw new IgnoreMeException();</span>
                }
<span class="nc" id="L197">                checkIfSmallFloatingPointText();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">                return castAs(rightVal.isSigned() ? CastType.SIGNED : CastType.UNSIGNED).isLessThan(rightVal);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            } else if (rightVal.isString()) {</span>
                // unexpected result for '-' &lt; &quot;!&quot;;
                // return
                // MySQLConstant.createBoolean(value.compareToIgnoreCase(rightVal.getString()) &lt;
                // 0);
<span class="nc" id="L204">                throw new IgnoreMeException();</span>
            } else {
<span class="nc" id="L206">                throw new AssertionError(rightVal);</span>
            }
        }

    }

    public static class MySQLIntConstant extends MySQLConstant {

        private final long value;
        private final String stringRepresentation;
        private final boolean isSigned;

<span class="nc" id="L218">        public MySQLIntConstant(long value, boolean isSigned) {</span>
<span class="nc" id="L219">            this.value = value;</span>
<span class="nc" id="L220">            this.isSigned = isSigned;</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if (isSigned) {</span>
<span class="nc" id="L222">                stringRepresentation = String.valueOf(value);</span>
<span class="nc" id="L223">            } else {</span>
<span class="nc" id="L224">                stringRepresentation = Long.toUnsignedString(value);</span>
            }
<span class="nc" id="L226">        }</span>

<span class="nc" id="L228">        public MySQLIntConstant(long value, String stringRepresentation) {</span>
<span class="nc" id="L229">            this.value = value;</span>
<span class="nc" id="L230">            this.stringRepresentation = stringRepresentation;</span>
<span class="nc" id="L231">            isSigned = true;</span>
<span class="nc" id="L232">        }</span>

        @Override
        public boolean isInt() {
<span class="nc" id="L236">            return true;</span>
        }

        @Override
        public long getInt() {
<span class="nc" id="L241">            return value;</span>
        }

        @Override
        public boolean asBooleanNotNull() {
<span class="nc bnc" id="L246" title="All 2 branches missed.">            return value != 0;</span>
        }

        @Override
        public String getTextRepresentation() {
<span class="nc" id="L251">            return stringRepresentation;</span>
        }

        @Override
        public MySQLConstant isEquals(MySQLConstant rightVal) {
<span class="nc bnc" id="L256" title="All 2 branches missed.">            if (rightVal.isInt()) {</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                return MySQLConstant.createBoolean(new BigInteger(getStringRepr())</span>
<span class="nc" id="L258">                        .compareTo(new BigInteger(((MySQLIntConstant) rightVal).getStringRepr())) == 0);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">            } else if (rightVal.isNull()) {</span>
<span class="nc" id="L260">                return MySQLConstant.createNullConstant();</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            } else if (rightVal.isString()) {</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                if (rightVal.asBooleanNotNull()) {</span>
                    // TODO support SELECT .123 = '.123'; by converting to floating point
<span class="nc" id="L264">                    throw new IgnoreMeException();</span>
                }
<span class="nc" id="L266">                return isEquals(rightVal.castAs(CastType.SIGNED));</span>
            } else {
<span class="nc" id="L268">                throw new AssertionError(rightVal);</span>
            }
        }

        @Override
        public MySQLConstant castAs(CastType type) {
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (type == CastType.SIGNED) {</span>
<span class="nc" id="L275">                return new MySQLIntConstant(value, true);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">            } else if (type == CastType.UNSIGNED) {</span>
<span class="nc" id="L277">                return new MySQLIntConstant(value, false);</span>
            } else {
<span class="nc" id="L279">                throw new AssertionError();</span>
            }
        }

        @Override
        public String castAsString() {
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (isSigned) {</span>
<span class="nc" id="L286">                return String.valueOf(value);</span>
            } else {
<span class="nc" id="L288">                return Long.toUnsignedString(value);</span>
            }
        }

        @Override
        public MySQLDataType getType() {
<span class="nc" id="L294">            return MySQLDataType.INT;</span>
        }

        @Override
        public boolean isSigned() {
<span class="nc" id="L299">            return isSigned;</span>
        }

        private String getStringRepr() {
<span class="nc bnc" id="L303" title="All 2 branches missed.">            if (isSigned) {</span>
<span class="nc" id="L304">                return String.valueOf(value);</span>
            } else {
<span class="nc" id="L306">                return Long.toUnsignedString(value);</span>
            }
        }

        @Override
        protected MySQLConstant isLessThan(MySQLConstant rightVal) {
<span class="nc bnc" id="L312" title="All 2 branches missed.">            if (rightVal.isInt()) {</span>
<span class="nc" id="L313">                long intVal = rightVal.getInt();</span>
<span class="nc bnc" id="L314" title="All 4 branches missed.">                if (isSigned &amp;&amp; rightVal.isSigned()) {</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">                    return MySQLConstant.createBoolean(value &lt; intVal);</span>
                } else {
<span class="nc bnc" id="L317" title="All 2 branches missed.">                    return MySQLConstant.createBoolean(new BigInteger(getStringRepr())</span>
<span class="nc" id="L318">                            .compareTo(new BigInteger(((MySQLIntConstant) rightVal).getStringRepr())) &lt; 0);</span>
                    // return MySQLConstant.createBoolean(Long.compareUnsigned(value, intVal) &lt; 0);
                }
<span class="nc bnc" id="L321" title="All 2 branches missed.">            } else if (rightVal.isNull()) {</span>
<span class="nc" id="L322">                return MySQLConstant.createNullConstant();</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">            } else if (rightVal.isString()) {</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                if (rightVal.asBooleanNotNull()) {</span>
                    // TODO support float
<span class="nc" id="L326">                    throw new IgnoreMeException();</span>
                }
<span class="nc bnc" id="L328" title="All 2 branches missed.">                return isLessThan(rightVal.castAs(isSigned ? CastType.SIGNED : CastType.UNSIGNED));</span>
            } else {
<span class="nc" id="L330">                throw new AssertionError(rightVal);</span>
            }
        }

    }

<span class="nc" id="L336">    public static class MySQLNullConstant extends MySQLConstant {</span>

        @Override
        public boolean isNull() {
<span class="nc" id="L340">            return true;</span>
        }

        @Override
        public boolean asBooleanNotNull() {
<span class="nc" id="L345">            throw new UnsupportedOperationException(this.toString());</span>
        }

        @Override
        public String getTextRepresentation() {
<span class="nc" id="L350">            return &quot;NULL&quot;;</span>
        }

        @Override
        public MySQLConstant isEquals(MySQLConstant rightVal) {
<span class="nc" id="L355">            return MySQLConstant.createNullConstant();</span>
        }

        @Override
        public MySQLConstant castAs(CastType type) {
<span class="nc" id="L360">            return this;</span>
        }

        @Override
        public String castAsString() {
<span class="nc" id="L365">            return &quot;NULL&quot;;</span>
        }

        @Override
        public MySQLDataType getType() {
<span class="nc" id="L370">            return null;</span>
        }

        @Override
        protected MySQLConstant isLessThan(MySQLConstant rightVal) {
<span class="nc" id="L375">            return this;</span>
        }

    }

    public long getInt() {
<span class="nc" id="L381">        throw new UnsupportedOperationException();</span>
    }

    public boolean isSigned() {
<span class="nc" id="L385">        return false;</span>
    }

    public String getString() {
<span class="nc" id="L389">        throw new UnsupportedOperationException();</span>
    }

    public boolean isString() {
<span class="nc" id="L393">        return false;</span>
    }

    public static MySQLConstant createNullConstant() {
<span class="nc" id="L397">        return new MySQLNullConstant();</span>
    }

    public static MySQLConstant createIntConstant(long value) {
<span class="nc" id="L401">        return new MySQLIntConstant(value, true);</span>
    }

    public static MySQLConstant createIntConstant(long value, boolean signed) {
<span class="nc" id="L405">        return new MySQLIntConstant(value, signed);</span>
    }

    public static MySQLConstant createUnsignedIntConstant(long value) {
<span class="nc" id="L409">        return new MySQLIntConstant(value, false);</span>
    }

    public static MySQLConstant createIntConstantNotAsBoolean(long value) {
<span class="nc" id="L413">        return new MySQLIntConstant(value, String.valueOf(value));</span>
    }

    @Override
    public MySQLConstant getExpectedValue() {
<span class="nc" id="L418">        return this;</span>
    }

    public abstract boolean asBooleanNotNull();

    public abstract String getTextRepresentation();

    public static MySQLConstant createFalse() {
<span class="nc" id="L426">        return MySQLConstant.createIntConstant(0);</span>
    }

    public static MySQLConstant createBoolean(boolean isTrue) {
<span class="nc bnc" id="L430" title="All 2 branches missed.">        return MySQLConstant.createIntConstant(isTrue ? 1 : 0);</span>
    }

    public static MySQLConstant createTrue() {
<span class="nc" id="L434">        return MySQLConstant.createIntConstant(1);</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L439">        return getTextRepresentation();</span>
    }

    public abstract MySQLConstant isEquals(MySQLConstant rightVal);

    public abstract MySQLConstant castAs(CastType type);

    public abstract String castAsString();

    public static MySQLConstant createStringConstant(String string) {
<span class="nc" id="L449">        return new MySQLTextConstant(string);</span>
    }

    public abstract MySQLDataType getType();

    protected abstract MySQLConstant isLessThan(MySQLConstant rightVal);

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>