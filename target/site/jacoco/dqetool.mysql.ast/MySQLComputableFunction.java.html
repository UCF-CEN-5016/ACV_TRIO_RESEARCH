<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MySQLComputableFunction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.mysql.ast</a> &gt; <span class="el_source">MySQLComputableFunction.java</span></div><h1>MySQLComputableFunction.java</h1><pre class="source lang-java linenums">package dqetool.mysql.ast;

import java.util.function.BinaryOperator;
import java.util.stream.Stream;

import dqetool.Randomly;
import dqetool.mysql.MySQLSchema.MySQLDataType;
import dqetool.mysql.ast.MySQLCastOperation.CastType;

public class MySQLComputableFunction implements MySQLExpression {

    private final MySQLFunction func;
    private final MySQLExpression[] args;

<span class="nc" id="L15">    public MySQLComputableFunction(MySQLFunction func, MySQLExpression... args) {</span>
<span class="nc" id="L16">        this.func = func;</span>
<span class="nc" id="L17">        this.args = args.clone();</span>
<span class="nc" id="L18">    }</span>

    public MySQLFunction getFunction() {
<span class="nc" id="L21">        return func;</span>
    }

    public MySQLExpression[] getArguments() {
<span class="nc" id="L25">        return args.clone();</span>
    }

<span class="nc" id="L28">    public enum MySQLFunction {</span>

<span class="nc" id="L30">        // ABS(1, &quot;ABS&quot;) {</span>
        // @Override
        // public MySQLConstant apply(MySQLConstant[] args, MySQLExpression[] origArgs) {
        // if (args[0].isNull()) {
        // return MySQLConstant.createNullConstant();
        // }
        // MySQLConstant intVal = args[0].castAs(CastType.SIGNED);
        // return MySQLConstant.createIntConstant(Math.abs(intVal.getInt()));
        // }
        // },
        /**
         * @see &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/bit-functions.html#function_bit-count&quot;&gt;Bit Functions
         *      and Operators&lt;/a&gt;
         */
<span class="nc" id="L44">        BIT_COUNT(1, &quot;BIT_COUNT&quot;) {</span>

            @Override
            public MySQLConstant apply(MySQLConstant[] evaluatedArgs, MySQLExpression... args) {
<span class="nc" id="L48">                MySQLConstant arg = evaluatedArgs[0];</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">                if (arg.isNull()) {</span>
<span class="nc" id="L50">                    return MySQLConstant.createNullConstant();</span>
                } else {
<span class="nc" id="L52">                    long val = arg.castAs(CastType.SIGNED).getInt();</span>
<span class="nc" id="L53">                    return MySQLConstant.createIntConstant(Long.bitCount(val));</span>
                }
            }

        },
<span class="nc" id="L58">        // BENCHMARK(2, &quot;BENCHMARK&quot;) {</span>
        //
        // @Override
        // public MySQLConstant apply(MySQLConstant[] evaluatedArgs, MySQLExpression[] args) {
        // if (evaluatedArgs[0].isNull()) {
        // return MySQLConstant.createNullConstant();
        // }
        // if (evaluatedArgs[0].castAs(CastType.SIGNED).getInt() &lt; 0) {
        // return MySQLConstant.createNullConstant();
        // }
        // if (Math.abs(evaluatedArgs[0].castAs(CastType.SIGNED).getInt()) &gt; 10) {
        // throw new IgnoreMeException();
        // }
        // return MySQLConstant.createIntConstant(0);
        // }
        //
        // },
<span class="nc" id="L75">        COALESCE(2, &quot;COALESCE&quot;) {</span>

            @Override
            public MySQLConstant apply(MySQLConstant[] args, MySQLExpression... origArgs) {
<span class="nc" id="L79">                MySQLConstant result = MySQLConstant.createNullConstant();</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">                for (MySQLConstant arg : args) {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                    if (!arg.isNull()) {</span>
<span class="nc" id="L82">                        result = MySQLConstant.createStringConstant(arg.castAsString());</span>
<span class="nc" id="L83">                        break;</span>
                    }
                }
<span class="nc" id="L86">                return castToMostGeneralType(result, origArgs);</span>
            }

            @Override
            public boolean isVariadic() {
<span class="nc" id="L91">                return true;</span>
            }

        },
<span class="nc" id="L95">        /**</span>
         * @see &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/control-flow-functions.html#function_if&quot;&gt;Flow Control
         *      Functions&lt;/a&gt;
         */
<span class="nc" id="L99">        IF(3, &quot;IF&quot;) {</span>

            @Override
            public MySQLConstant apply(MySQLConstant[] args, MySQLExpression... origArgs) {
<span class="nc" id="L103">                MySQLConstant cond = args[0];</span>
<span class="nc" id="L104">                MySQLConstant left = args[1];</span>
<span class="nc" id="L105">                MySQLConstant right = args[2];</span>
                MySQLConstant result;
<span class="nc bnc" id="L107" title="All 4 branches missed.">                if (cond.isNull() || !cond.asBooleanNotNull()) {</span>
<span class="nc" id="L108">                    result = right;</span>
<span class="nc" id="L109">                } else {</span>
<span class="nc" id="L110">                    result = left;</span>
                }
<span class="nc" id="L112">                return castToMostGeneralType(result, new MySQLExpression[] { origArgs[1], origArgs[2] });</span>

            }

        },
<span class="nc" id="L117">        /**</span>
         * @see &lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/control-flow-functions.html#function_ifnull&quot;&gt;IFNULL&lt;/a&gt;
         */
<span class="nc" id="L120">        IFNULL(2, &quot;IFNULL&quot;) {</span>

            @Override
            public MySQLConstant apply(MySQLConstant[] args, MySQLExpression... origArgs) {
                MySQLConstant result;
<span class="nc bnc" id="L125" title="All 2 branches missed.">                if (args[0].isNull()) {</span>
<span class="nc" id="L126">                    result = args[1];</span>
<span class="nc" id="L127">                } else {</span>
<span class="nc" id="L128">                    result = args[0];</span>
                }
<span class="nc" id="L130">                return castToMostGeneralType(result, origArgs);</span>
            }

        },
<span class="nc" id="L134">        LEAST(2, &quot;LEAST&quot;, true) {</span>

            @Override
            public MySQLConstant apply(MySQLConstant[] evaluatedArgs, MySQLExpression... args) {
<span class="nc bnc" id="L138" title="All 2 branches missed.">                return aggregate(evaluatedArgs, (min, cur) -&gt; cur.isLessThan(min).asBooleanNotNull() ? cur : min);</span>
            }

        },
<span class="nc" id="L142">        GREATEST(2, &quot;GREATEST&quot;, true) {</span>
            @Override
            public MySQLConstant apply(MySQLConstant[] evaluatedArgs, MySQLExpression... args) {
<span class="nc bnc" id="L145" title="All 2 branches missed.">                return aggregate(evaluatedArgs, (max, cur) -&gt; cur.isLessThan(max).asBooleanNotNull() ? max : cur);</span>
            }
        };

        private String functionName;
        final int nrArgs;
        private final boolean variadic;

        private static MySQLConstant aggregate(MySQLConstant[] evaluatedArgs, BinaryOperator&lt;MySQLConstant&gt; op) {
<span class="nc" id="L154">            boolean containsNull = Stream.of(evaluatedArgs).anyMatch(arg -&gt; arg.isNull());</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (containsNull) {</span>
<span class="nc" id="L156">                return MySQLConstant.createNullConstant();</span>
            }
<span class="nc" id="L158">            MySQLConstant least = evaluatedArgs[1];</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            for (MySQLConstant arg : evaluatedArgs) {</span>
<span class="nc" id="L160">                MySQLConstant left = castToMostGeneralType(least, evaluatedArgs);</span>
<span class="nc" id="L161">                MySQLConstant right = castToMostGeneralType(arg, evaluatedArgs);</span>
<span class="nc" id="L162">                least = op.apply(right, left);</span>
            }
<span class="nc" id="L164">            return castToMostGeneralType(least, evaluatedArgs);</span>
        }

<span class="nc" id="L167">        MySQLFunction(int nrArgs, String functionName) {</span>
<span class="nc" id="L168">            this.nrArgs = nrArgs;</span>
<span class="nc" id="L169">            this.functionName = functionName;</span>
<span class="nc" id="L170">            this.variadic = false;</span>
<span class="nc" id="L171">        }</span>

<span class="nc" id="L173">        MySQLFunction(int nrArgs, String functionName, boolean variadic) {</span>
<span class="nc" id="L174">            this.nrArgs = nrArgs;</span>
<span class="nc" id="L175">            this.functionName = functionName;</span>
<span class="nc" id="L176">            this.variadic = variadic;</span>
<span class="nc" id="L177">        }</span>

        /**
         * Gets the number of arguments if the function is non-variadic. If the function is variadic, the minimum number
         * of arguments is returned.
         *
         * @return the number of arguments
         */
        public int getNrArgs() {
<span class="nc" id="L186">            return nrArgs;</span>
        }

        public abstract MySQLConstant apply(MySQLConstant[] evaluatedArgs, MySQLExpression... args);

        public static MySQLFunction getRandomFunction() {
<span class="nc" id="L192">            return Randomly.fromOptions(values());</span>
        }

        @Override
        public String toString() {
<span class="nc" id="L197">            return functionName;</span>
        }

        public boolean isVariadic() {
<span class="nc" id="L201">            return variadic;</span>
        }

        public String getName() {
<span class="nc" id="L205">            return functionName;</span>
        }
    }

    @Override
    public MySQLConstant getExpectedValue() {
<span class="nc" id="L211">        MySQLConstant[] constants = new MySQLConstant[args.length];</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">        for (int i = 0; i &lt; constants.length; i++) {</span>
<span class="nc" id="L213">            constants[i] = args[i].getExpectedValue();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            if (constants[i].getExpectedValue() == null) {</span>
<span class="nc" id="L215">                return null;</span>
            }
        }
<span class="nc" id="L218">        return func.apply(constants, args);</span>
    }

    public static MySQLConstant castToMostGeneralType(MySQLConstant cons, MySQLExpression... typeExpressions) {
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (cons.isNull()) {</span>
<span class="nc" id="L223">            return cons;</span>
        }
<span class="nc" id="L225">        MySQLDataType type = getMostGeneralType(typeExpressions);</span>
<span class="nc bnc" id="L226" title="All 3 branches missed.">        switch (type) {</span>
        case INT:
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (cons.isInt()) {</span>
<span class="nc" id="L229">                return cons;</span>
            } else {
<span class="nc" id="L231">                return MySQLConstant.createIntConstant(cons.castAs(CastType.SIGNED).getInt());</span>
            }
        case VARCHAR:
<span class="nc" id="L234">            return MySQLConstant.createStringConstant(cons.castAsString());</span>
        default:
<span class="nc" id="L236">            throw new AssertionError(type);</span>
        }
    }

    public static MySQLDataType getMostGeneralType(MySQLExpression... expressions) {
<span class="nc" id="L241">        MySQLDataType type = null;</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">        for (MySQLExpression expr : expressions) {</span>
            MySQLDataType exprType;
<span class="nc bnc" id="L244" title="All 2 branches missed.">            if (expr instanceof MySQLColumnReference) {</span>
<span class="nc" id="L245">                exprType = ((MySQLColumnReference) expr).getColumn().getType();</span>
<span class="nc" id="L246">            } else {</span>
<span class="nc" id="L247">                exprType = expr.getExpectedValue().getType();</span>
            }
<span class="nc bnc" id="L249" title="All 2 branches missed.">            if (type == null) {</span>
<span class="nc" id="L250">                type = exprType;</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">            } else if (exprType == MySQLDataType.VARCHAR) {</span>
<span class="nc" id="L252">                type = MySQLDataType.VARCHAR;</span>
            }

        }
<span class="nc" id="L256">        return type;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>