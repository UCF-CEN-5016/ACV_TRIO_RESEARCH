<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MySQLBinaryComparisonOperation.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.mysql.ast</a> &gt; <span class="el_source">MySQLBinaryComparisonOperation.java</span></div><h1>MySQLBinaryComparisonOperation.java</h1><pre class="source lang-java linenums">package dqetool.mysql.ast;

import dqetool.LikeImplementationHelper;
import dqetool.Randomly;
import dqetool.mysql.MySQLSchema.MySQLDataType;
import dqetool.mysql.ast.MySQLUnaryPrefixOperation.MySQLUnaryPrefixOperator;

public class MySQLBinaryComparisonOperation implements MySQLExpression {

<span class="nc" id="L10">    public enum BinaryComparisonOperator {</span>
<span class="nc" id="L11">        EQUALS(&quot;=&quot;) {</span>
            @Override
            public MySQLConstant getExpectedValue(MySQLConstant leftVal, MySQLConstant rightVal) {
<span class="nc" id="L14">                return leftVal.isEquals(rightVal);</span>
            }
        },
<span class="nc" id="L17">        NOT_EQUALS(&quot;!=&quot;) {</span>
            @Override
            public MySQLConstant getExpectedValue(MySQLConstant leftVal, MySQLConstant rightVal) {
<span class="nc" id="L20">                MySQLConstant isEquals = leftVal.isEquals(rightVal);</span>
<span class="nc bnc" id="L21" title="All 2 branches missed.">                if (isEquals.getType() == MySQLDataType.INT) {</span>
<span class="nc" id="L22">                    return MySQLConstant.createIntConstant(1 - isEquals.getInt());</span>
                }
<span class="nc" id="L24">                return isEquals;</span>
            }
        },
<span class="nc" id="L27">        LESS(&quot;&lt;&quot;) {</span>

            @Override
            public MySQLConstant getExpectedValue(MySQLConstant leftVal, MySQLConstant rightVal) {
<span class="nc" id="L31">                return leftVal.isLessThan(rightVal);</span>
            }
        },
<span class="nc" id="L34">        LESS_EQUALS(&quot;&lt;=&quot;) {</span>

            @Override
            public MySQLConstant getExpectedValue(MySQLConstant leftVal, MySQLConstant rightVal) {
<span class="nc" id="L38">                MySQLConstant lessThan = leftVal.isLessThan(rightVal);</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">                if (lessThan == null) {</span>
<span class="nc" id="L40">                    return null;</span>
                }
<span class="nc bnc" id="L42" title="All 4 branches missed.">                if (lessThan.getType() == MySQLDataType.INT &amp;&amp; lessThan.getInt() == 0) {</span>
<span class="nc" id="L43">                    return leftVal.isEquals(rightVal);</span>
                } else {
<span class="nc" id="L45">                    return lessThan;</span>
                }
            }
        },
<span class="nc" id="L49">        GREATER(&quot;&gt;&quot;) {</span>
            @Override
            public MySQLConstant getExpectedValue(MySQLConstant leftVal, MySQLConstant rightVal) {
<span class="nc" id="L52">                MySQLConstant equals = leftVal.isEquals(rightVal);</span>
<span class="nc bnc" id="L53" title="All 4 branches missed.">                if (equals.getType() == MySQLDataType.INT &amp;&amp; equals.getInt() == 1) {</span>
<span class="nc" id="L54">                    return MySQLConstant.createFalse();</span>
                } else {
<span class="nc" id="L56">                    MySQLConstant applyLess = leftVal.isLessThan(rightVal);</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">                    if (applyLess.isNull()) {</span>
<span class="nc" id="L58">                        return MySQLConstant.createNullConstant();</span>
                    }
<span class="nc" id="L60">                    return MySQLUnaryPrefixOperator.NOT.applyNotNull(applyLess);</span>
                }
            }
        },
<span class="nc" id="L64">        GREATER_EQUALS(&quot;&gt;=&quot;) {</span>

            @Override
            public MySQLConstant getExpectedValue(MySQLConstant leftVal, MySQLConstant rightVal) {
<span class="nc" id="L68">                MySQLConstant equals = leftVal.isEquals(rightVal);</span>
<span class="nc bnc" id="L69" title="All 4 branches missed.">                if (equals.getType() == MySQLDataType.INT &amp;&amp; equals.getInt() == 1) {</span>
<span class="nc" id="L70">                    return MySQLConstant.createTrue();</span>
                } else {
<span class="nc" id="L72">                    MySQLConstant applyLess = leftVal.isLessThan(rightVal);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">                    if (applyLess.isNull()) {</span>
<span class="nc" id="L74">                        return MySQLConstant.createNullConstant();</span>
                    }
<span class="nc" id="L76">                    return MySQLUnaryPrefixOperator.NOT.applyNotNull(applyLess);</span>
                }
            }

        },
<span class="nc" id="L81">        LIKE(&quot;LIKE&quot;) {</span>

            @Override
            public MySQLConstant getExpectedValue(MySQLConstant leftVal, MySQLConstant rightVal) {
<span class="nc bnc" id="L85" title="All 4 branches missed.">                if (leftVal.isNull() || rightVal.isNull()) {</span>
<span class="nc" id="L86">                    return MySQLConstant.createNullConstant();</span>
                }
<span class="nc" id="L88">                String leftStr = leftVal.castAsString();</span>
<span class="nc" id="L89">                String rightStr = rightVal.castAsString();</span>
<span class="nc" id="L90">                boolean matches = LikeImplementationHelper.match(leftStr, rightStr, 0, 0, false);</span>
<span class="nc" id="L91">                return MySQLConstant.createBoolean(matches);</span>
            }

        };
        // https://bugs.mysql.com/bug.php?id=95908
        /*
         * IS_EQUALS_NULL_SAFE(&quot;&lt;=&gt;&quot;) {
         *
         * @Override public MySQLConstant getExpectedValue(MySQLConstant leftVal, MySQLConstant rightVal) { return
         * leftVal.isEqualsNullSafe(rightVal); }
         *
         * };
         */

        private final String textRepresentation;

        public String getTextRepresentation() {
<span class="nc" id="L108">            return textRepresentation;</span>
        }

<span class="nc" id="L111">        BinaryComparisonOperator(String textRepresentation) {</span>
<span class="nc" id="L112">            this.textRepresentation = textRepresentation;</span>
<span class="nc" id="L113">        }</span>

        public abstract MySQLConstant getExpectedValue(MySQLConstant leftVal, MySQLConstant rightVal);

        public static BinaryComparisonOperator getRandom() {
<span class="nc" id="L118">            return Randomly.fromOptions(BinaryComparisonOperator.values());</span>
        }
    }

    private final MySQLExpression left;
    private final MySQLExpression right;
    private final BinaryComparisonOperator op;

<span class="nc" id="L126">    public MySQLBinaryComparisonOperation(MySQLExpression left, MySQLExpression right, BinaryComparisonOperator op) {</span>
<span class="nc" id="L127">        this.left = left;</span>
<span class="nc" id="L128">        this.right = right;</span>
<span class="nc" id="L129">        this.op = op;</span>
<span class="nc" id="L130">    }</span>

    public MySQLExpression getLeft() {
<span class="nc" id="L133">        return left;</span>
    }

    public BinaryComparisonOperator getOp() {
<span class="nc" id="L137">        return op;</span>
    }

    public MySQLExpression getRight() {
<span class="nc" id="L141">        return right;</span>
    }

    @Override
    public MySQLConstant getExpectedValue() {
<span class="nc" id="L146">        return op.getExpectedValue(left.getExpectedValue(), right.getExpectedValue());</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>