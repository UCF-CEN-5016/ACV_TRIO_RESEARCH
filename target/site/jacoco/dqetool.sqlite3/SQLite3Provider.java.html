<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SQLite3Provider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dqetool</a> &gt; <a href="index.source.html" class="el_package">dqetool.sqlite3</a> &gt; <span class="el_source">SQLite3Provider.java</span></div><h1>SQLite3Provider.java</h1><pre class="source lang-java linenums">package dqetool.sqlite3;

import java.io.File;
import java.io.IOException;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

import com.google.auto.service.AutoService;

import dqetool.AbstractAction;
import dqetool.DatabaseProvider;
import dqetool.IgnoreMeException;
import dqetool.Randomly;
import dqetool.SQLConnection;
import dqetool.SQLProviderAdapter;
import dqetool.StatementExecutor;
import dqetool.common.DBMSCommon;
import dqetool.common.query.ExpectedErrors;
import dqetool.common.query.SQLQueryAdapter;
import dqetool.common.query.SQLQueryProvider;
import dqetool.common.query.SQLancerResultSet;
import dqetool.sqlite3.gen.SQLite3AnalyzeGenerator;
import dqetool.sqlite3.gen.SQLite3CreateVirtualRtreeTabelGenerator;
import dqetool.sqlite3.gen.SQLite3ExplainGenerator;
import dqetool.sqlite3.gen.SQLite3PragmaGenerator;
import dqetool.sqlite3.gen.SQLite3ReindexGenerator;
import dqetool.sqlite3.gen.SQLite3TransactionGenerator;
import dqetool.sqlite3.gen.SQLite3VacuumGenerator;
import dqetool.sqlite3.gen.SQLite3VirtualFTSTableCommandGenerator;
import dqetool.sqlite3.gen.ddl.SQLite3AlterTable;
import dqetool.sqlite3.gen.ddl.SQLite3CreateTriggerGenerator;
import dqetool.sqlite3.gen.ddl.SQLite3CreateVirtualFTSTableGenerator;
import dqetool.sqlite3.gen.ddl.SQLite3DropIndexGenerator;
import dqetool.sqlite3.gen.ddl.SQLite3DropTableGenerator;
import dqetool.sqlite3.gen.ddl.SQLite3IndexGenerator;
import dqetool.sqlite3.gen.ddl.SQLite3TableGenerator;
import dqetool.sqlite3.gen.dml.SQLite3DeleteGenerator;
import dqetool.sqlite3.gen.dml.SQLite3InsertGenerator;
import dqetool.sqlite3.gen.dml.SQLite3StatTableGenerator;
import dqetool.sqlite3.gen.dml.SQLite3UpdateGenerator;
import dqetool.sqlite3.schema.SQLite3Schema.SQLite3Table;

@AutoService(DatabaseProvider.class)
public class SQLite3Provider extends SQLProviderAdapter&lt;SQLite3GlobalState, SQLite3Options&gt; {

<span class="fc" id="L50">    public static boolean allowFloatingPointFp = true;</span>
    public static boolean mustKnowResult;

    // PRAGMAS to achieve good performance
<span class="fc" id="L54">    private static final List&lt;String&gt; DEFAULT_PRAGMAS = Arrays.asList(&quot;PRAGMA cache_size = 50000;&quot;,</span>
<span class="fc" id="L55">            &quot;PRAGMA temp_store=MEMORY;&quot;, &quot;PRAGMA synchronous=off;&quot;);</span>

    public SQLite3Provider() {
<span class="fc" id="L58">        super(SQLite3GlobalState.class, SQLite3Options.class);</span>
<span class="fc" id="L59">    }</span>

<span class="nc" id="L61">    public enum Action implements AbstractAction&lt;SQLite3GlobalState&gt; {</span>
<span class="nc" id="L62">        PRAGMA(SQLite3PragmaGenerator::insertPragma), // 0</span>
<span class="nc" id="L63">        CREATE_INDEX(SQLite3IndexGenerator::insertIndex), // 1</span>
<span class="nc" id="L64">        CREATE_TRIGGER(SQLite3CreateTriggerGenerator::create), // 3</span>
<span class="nc" id="L65">        CREATE_TABLE(SQLite3TableGenerator::createRandomTableStatement), // 4</span>
<span class="nc" id="L66">        CREATE_VIRTUALTABLE(SQLite3CreateVirtualFTSTableGenerator::createRandomTableStatement), // 5</span>
<span class="nc" id="L67">        CREATE_RTREETABLE(SQLite3CreateVirtualRtreeTabelGenerator::createRandomTableStatement), // 6</span>
<span class="nc" id="L68">        INSERT(SQLite3InsertGenerator::insertRow), // 7</span>
<span class="nc" id="L69">        DELETE(SQLite3DeleteGenerator::deleteContent), // 8</span>
<span class="nc" id="L70">        ALTER(SQLite3AlterTable::alterTable), // 9</span>
<span class="nc" id="L71">        UPDATE(SQLite3UpdateGenerator::updateRow), // 10</span>
<span class="nc" id="L72">        DROP_INDEX(SQLite3DropIndexGenerator::dropIndex), // 11</span>
<span class="nc" id="L73">        DROP_TABLE(SQLite3DropTableGenerator::dropTable), // 12</span>
<span class="nc" id="L74">        VACUUM(SQLite3VacuumGenerator::executeVacuum), // 14</span>
<span class="nc" id="L75">        REINDEX(SQLite3ReindexGenerator::executeReindex), // 15</span>
<span class="nc" id="L76">        ANALYZE(SQLite3AnalyzeGenerator::generateAnalyze), // 16</span>
<span class="nc" id="L77">        EXPLAIN(SQLite3ExplainGenerator::explain), // 17</span>
<span class="nc" id="L78">        CHECK_RTREE_TABLE((g) -&gt; {</span>
<span class="nc" id="L79">            SQLite3Table table = g.getSchema().getRandomTableOrBailout(t -&gt; t.getName().startsWith(&quot;r&quot;));</span>
<span class="nc" id="L80">            String format = String.format(&quot;SELECT rtreecheck('%s');&quot;, table.getName());</span>
<span class="nc" id="L81">            return new SQLQueryAdapter(format, ExpectedErrors.from(&quot;The database file is locked&quot;));</span>
<span class="nc" id="L82">        }), // 18</span>
<span class="nc" id="L83">        VIRTUAL_TABLE_ACTION(SQLite3VirtualFTSTableCommandGenerator::create), // 19</span>
<span class="nc" id="L84">        MANIPULATE_STAT_TABLE(SQLite3StatTableGenerator::getQuery), // 20</span>
<span class="nc" id="L85">        TRANSACTION_START(SQLite3TransactionGenerator::generateBeginTransaction) {</span>
            @Override
            public boolean canBeRetried() {
<span class="nc" id="L88">                return false;</span>
            }

<span class="nc" id="L91">        }, // 21</span>
<span class="nc" id="L92">        ROLLBACK_TRANSACTION(SQLite3TransactionGenerator::generateRollbackTransaction) {</span>
            @Override
            public boolean canBeRetried() {
<span class="nc" id="L95">                return false;</span>
            }
<span class="nc" id="L97">        }, // 22</span>
<span class="nc" id="L98">        COMMIT(SQLite3TransactionGenerator::generateCommit) {</span>
            @Override
            public boolean canBeRetried() {
<span class="nc" id="L101">                return false;</span>
            }
        }; // 23

        private final SQLQueryProvider&lt;SQLite3GlobalState&gt; sqlQueryProvider;

<span class="nc" id="L107">        Action(SQLQueryProvider&lt;SQLite3GlobalState&gt; sqlQueryProvider) {</span>
<span class="nc" id="L108">            this.sqlQueryProvider = sqlQueryProvider;</span>
<span class="nc" id="L109">        }</span>

        @Override
        public SQLQueryAdapter getQuery(SQLite3GlobalState state) throws Exception {
<span class="nc" id="L113">            return sqlQueryProvider.getQuery(state);</span>
        }
    }

<span class="nc" id="L117">    private enum TableType {</span>
<span class="nc" id="L118">        NORMAL, FTS, RTREE</span>
    }

    private static int mapActions(SQLite3GlobalState globalState, Action a) {
<span class="nc" id="L122">        int nrPerformed = 0;</span>
<span class="nc" id="L123">        Randomly r = globalState.getRandomly();</span>
<span class="nc bnc" id="L124" title="All 11 branches missed.">        switch (a) {</span>
        case DELETE:
        case DROP_INDEX:
<span class="nc" id="L127">            nrPerformed = r.getInteger(0, 0);</span>
<span class="nc" id="L128">            break;</span>
        case ALTER:
<span class="nc" id="L130">            nrPerformed = r.getInteger(0, 0);</span>
<span class="nc" id="L131">            break;</span>
        case EXPLAIN:
        case CREATE_TRIGGER:
        case DROP_TABLE:
<span class="nc" id="L135">            nrPerformed = r.getInteger(0, 0);</span>
<span class="nc" id="L136">            break;</span>
        case VACUUM:
        case CHECK_RTREE_TABLE:
<span class="nc" id="L139">            nrPerformed = r.getInteger(0, 3);</span>
<span class="nc" id="L140">            break;</span>
        case INSERT:
<span class="nc" id="L142">            nrPerformed = r.getInteger(0, globalState.getOptions().getMaxNumberInserts());</span>
<span class="nc" id="L143">            break;</span>
        case MANIPULATE_STAT_TABLE:
<span class="nc" id="L145">            nrPerformed = r.getInteger(0, 5);</span>
<span class="nc" id="L146">            break;</span>
        case CREATE_INDEX:
<span class="nc" id="L148">            nrPerformed = r.getInteger(0, 5);</span>
<span class="nc" id="L149">            break;</span>
        case VIRTUAL_TABLE_ACTION:
        case UPDATE:
<span class="nc" id="L152">            nrPerformed = r.getInteger(0, 30);</span>
<span class="nc" id="L153">            break;</span>
        case PRAGMA:
<span class="nc" id="L155">            nrPerformed = r.getInteger(0, 20);</span>
<span class="nc" id="L156">            break;</span>
        case CREATE_TABLE:
        case CREATE_VIRTUALTABLE:
        case CREATE_RTREETABLE:
<span class="nc" id="L160">            nrPerformed = 0;</span>
<span class="nc" id="L161">            break;</span>
        case TRANSACTION_START:
        case REINDEX:
        case ANALYZE:
        case ROLLBACK_TRANSACTION:
        case COMMIT:
        default:
<span class="nc" id="L168">            nrPerformed = r.getInteger(1, 10);</span>
            break;
        }
<span class="nc" id="L171">        return nrPerformed;</span>
    }

    @Override
    public void generateDatabase(SQLite3GlobalState globalState) throws Exception {
<span class="nc" id="L176">        Randomly r = new Randomly(SQLite3SpecialStringGenerator::generate);</span>
<span class="nc" id="L177">        globalState.setRandomly(r);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (globalState.getDbmsSpecificOptions().generateDatabase) {</span>

<span class="nc" id="L180">            addSensiblePragmaDefaults(globalState);</span>
<span class="nc" id="L181">            int nrTablesToCreate = 1;</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            if (Randomly.getBoolean()) {</span>
<span class="nc" id="L183">                nrTablesToCreate++;</span>
            }
<span class="nc bnc" id="L185" title="All 2 branches missed.">            while (Randomly.getBooleanWithSmallProbability()) {</span>
<span class="nc" id="L186">                nrTablesToCreate++;</span>
            }
<span class="nc" id="L188">            int i = 0;</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">            do {</span>
<span class="nc" id="L191">                SQLQueryAdapter tableQuery = getTableQuery(globalState, i++);</span>
<span class="nc" id="L192">                globalState.executeStatement(tableQuery);</span>
<span class="nc" id="L193">            } while (globalState.getSchema().getDatabaseTables().size() &lt; nrTablesToCreate);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            assert globalState.getSchema().getTables().getTables().size() == nrTablesToCreate;</span>
<span class="nc" id="L195">            checkTablesForGeneratedColumnLoops(globalState);</span>
<span class="nc bnc" id="L196" title="All 4 branches missed.">            if (globalState.getDbmsSpecificOptions().testDBStats &amp;&amp; Randomly.getBooleanWithSmallProbability()) {</span>
<span class="nc" id="L197">                SQLQueryAdapter tableQuery = new SQLQueryAdapter(</span>
<span class="nc" id="L198">                        &quot;CREATE VIRTUAL TABLE IF NOT EXISTS stat USING dbstat(main)&quot;);</span>
<span class="nc" id="L199">                globalState.executeStatement(tableQuery);</span>
            }
<span class="nc" id="L201">            StatementExecutor&lt;SQLite3GlobalState, Action&gt; se = new StatementExecutor&lt;&gt;(globalState, Action.values(),</span>
<span class="nc" id="L202">                    SQLite3Provider::mapActions, (q) -&gt; {</span>
<span class="nc bnc" id="L203" title="All 4 branches missed.">                        if (q.couldAffectSchema() &amp;&amp; globalState.getSchema().getDatabaseTables().isEmpty()) {</span>
<span class="nc" id="L204">                            throw new IgnoreMeException();</span>
                        }
<span class="nc" id="L206">                    });</span>
<span class="nc" id="L207">            se.executeStatements();</span>

<span class="nc" id="L209">            SQLQueryAdapter query = SQLite3TransactionGenerator.generateCommit(globalState);</span>
<span class="nc" id="L210">            globalState.executeStatement(query);</span>

            // also do an abort for DEFERRABLE INITIALLY DEFERRED
<span class="nc" id="L213">            query = SQLite3TransactionGenerator.generateRollbackTransaction(globalState);</span>
<span class="nc" id="L214">            globalState.executeStatement(query);</span>
        }
<span class="nc" id="L216">    }</span>

    private void checkTablesForGeneratedColumnLoops(SQLite3GlobalState globalState) throws Exception {
<span class="nc bnc" id="L219" title="All 2 branches missed.">        for (SQLite3Table table : globalState.getSchema().getDatabaseTables()) {</span>
<span class="nc" id="L220">            SQLQueryAdapter q = new SQLQueryAdapter(&quot;SELECT * FROM &quot; + table.getName(),</span>
<span class="nc" id="L221">                    ExpectedErrors.from(&quot;needs an odd number of arguments&quot;, &quot; requires an even number of arguments&quot;,</span>
<span class="nc" id="L222">                            &quot;generated column loop&quot;, &quot;integer overflow&quot;, &quot;malformed JSON&quot;,</span>
<span class="nc" id="L223">                            &quot;JSON cannot hold BLOB values&quot;, &quot;JSON path error&quot;, &quot;labels must be TEXT&quot;,</span>
<span class="nc" id="L224">                            &quot;table does not support scanning&quot;));</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            if (!q.execute(globalState)) {</span>
<span class="nc" id="L226">                throw new IgnoreMeException();</span>
            }
        }
<span class="nc" id="L229">    }</span>

    private SQLQueryAdapter getTableQuery(SQLite3GlobalState globalState, int i) throws AssertionError {
        SQLQueryAdapter tableQuery;
<span class="nc" id="L233">        List&lt;TableType&gt; options = new ArrayList&lt;&gt;(Arrays.asList(TableType.values()));</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (!globalState.getDbmsSpecificOptions().testFts) {</span>
<span class="nc" id="L235">            options.remove(TableType.FTS);</span>
        }
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (!globalState.getDbmsSpecificOptions().testRtree) {</span>
<span class="nc" id="L238">            options.remove(TableType.RTREE);</span>
        }
<span class="nc bnc" id="L240" title="All 4 branches missed.">        switch (Randomly.fromList(options)) {</span>
        case NORMAL:
<span class="nc" id="L242">            String tableName = DBMSCommon.createTableName(i);</span>
<span class="nc" id="L243">            tableQuery = SQLite3TableGenerator.createTableStatement(tableName, globalState);</span>
<span class="nc" id="L244">            break;</span>
        case FTS:
<span class="nc" id="L246">            String ftsTableName = &quot;v&quot; + DBMSCommon.createTableName(i);</span>
<span class="nc" id="L247">            tableQuery = SQLite3CreateVirtualFTSTableGenerator.createTableStatement(ftsTableName,</span>
<span class="nc" id="L248">                    globalState.getRandomly());</span>
<span class="nc" id="L249">            break;</span>
        case RTREE:
<span class="nc" id="L251">            String rTreeTableName = &quot;rt&quot; + i;</span>
<span class="nc" id="L252">            tableQuery = SQLite3CreateVirtualRtreeTabelGenerator.createTableStatement(rTreeTableName, globalState);</span>
<span class="nc" id="L253">            break;</span>
        default:
<span class="nc" id="L255">            throw new AssertionError();</span>
        }
<span class="nc" id="L257">        return tableQuery;</span>
    }

    private void addSensiblePragmaDefaults(SQLite3GlobalState globalState) throws Exception {
<span class="nc" id="L261">        List&lt;String&gt; pragmasToExecute = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (!Randomly.getBooleanWithSmallProbability()) {</span>
<span class="nc" id="L263">            pragmasToExecute.addAll(DEFAULT_PRAGMAS);</span>
        }
<span class="nc" id="L265">        pragmasToExecute.add(&quot;PRAGMA case_sensitive_like=ON;&quot;);</span>
<span class="nc" id="L266">        pragmasToExecute.add(String.format(&quot;PRAGMA encoding = '%s';&quot;,</span>
<span class="nc" id="L267">                Randomly.fromOptions(&quot;UTF-8&quot;, &quot;UTF-16&quot;, &quot;UTF-16le&quot;, &quot;UTF-16be&quot;)));</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        for (String s : pragmasToExecute) {</span>
<span class="nc" id="L269">            globalState.executeStatement(new SQLQueryAdapter(s));</span>
        }
<span class="nc" id="L271">    }</span>

    @Override
    public SQLConnection createDatabase(SQLite3GlobalState globalState) throws SQLException {
<span class="nc" id="L275">        File dir = new File(&quot;.&quot; + File.separator + &quot;databases&quot;);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (!dir.exists()) {</span>
<span class="nc" id="L277">            dir.mkdir();</span>
        }
<span class="nc" id="L279">        File dataBase = new File(dir, globalState.getDatabaseName() + &quot;.db&quot;);</span>
<span class="nc bnc" id="L280" title="All 4 branches missed.">        if (dataBase.exists() &amp;&amp; ((SQLite3GlobalState) globalState).getDbmsSpecificOptions().deleteIfExists) {</span>
<span class="nc" id="L281">            dataBase.delete();</span>
        }
<span class="nc" id="L283">        String url = &quot;jdbc:sqlite:&quot; + dataBase.getAbsolutePath();</span>
<span class="nc" id="L284">        return new SQLConnection(DriverManager.getConnection(url));</span>
    }

    @Override
    public String getDBMSName() {
<span class="fc" id="L289">        return &quot;sqlite3&quot;;</span>
    }

    @Override
    public String getQueryPlan(String selectStr, SQLite3GlobalState globalState) throws Exception {
<span class="nc" id="L294">        String queryPlan = &quot;&quot;;</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (globalState.getOptions().logEachSelect()) {</span>
<span class="nc" id="L296">            globalState.getLogger().writeCurrent(selectStr);</span>
            try {
<span class="nc" id="L298">                globalState.getLogger().getCurrentFileWriter().flush();</span>
<span class="nc" id="L299">            } catch (IOException e) {</span>
<span class="nc" id="L300">                e.printStackTrace();</span>
            }
        }
        // Set up the expected errors for NoREC oracle.
<span class="nc" id="L304">        ExpectedErrors errors = new ExpectedErrors();</span>
<span class="nc" id="L305">        SQLite3Errors.addExpectedExpressionErrors(errors);</span>
<span class="nc" id="L306">        SQLite3Errors.addMatchQueryErrors(errors);</span>
<span class="nc" id="L307">        SQLite3Errors.addQueryErrors(errors);</span>
<span class="nc" id="L308">        SQLite3Errors.addInsertUpdateErrors(errors);</span>

<span class="nc" id="L310">        SQLQueryAdapter q = new SQLQueryAdapter(SQLite3ExplainGenerator.explain(selectStr), errors);</span>
<span class="nc" id="L311">        try (SQLancerResultSet rs = q.executeAndGet(globalState)) {</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            if (rs != null) {</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L314">                    queryPlan += rs.getString(4) + &quot;;&quot;;</span>
                }
            }
<span class="nc" id="L317">        } catch (SQLException | AssertionError e) {</span>
<span class="nc" id="L318">            queryPlan = &quot;&quot;;</span>
        }
<span class="nc" id="L320">        return queryPlan;</span>
    }

    @Override
    protected double[] initializeWeightedAverageReward() {
<span class="nc" id="L325">        return new double[Action.values().length];</span>
    }

    @Override
    protected void executeMutator(int index, SQLite3GlobalState globalState) throws Exception {
<span class="nc" id="L330">        SQLQueryAdapter queryMutateTable = Action.values()[index].getQuery(globalState);</span>
<span class="nc" id="L331">        globalState.executeStatement(queryMutateTable);</span>

<span class="nc" id="L333">    }</span>

    @Override
    protected boolean addRowsToAllTables(SQLite3GlobalState globalState) throws Exception {
<span class="nc" id="L337">        List&lt;SQLite3Table&gt; tablesNoRow = globalState.getSchema().getDatabaseTables().stream()</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                .filter(t -&gt; t.getNrRows(globalState) == 0).collect(Collectors.toList());</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        for (SQLite3Table table : tablesNoRow) {</span>
<span class="nc" id="L340">            SQLQueryAdapter queryAddRows = SQLite3InsertGenerator.insertRow(globalState, table);</span>
<span class="nc" id="L341">            globalState.executeStatement(queryAddRows);</span>
        }

<span class="nc" id="L344">        return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>